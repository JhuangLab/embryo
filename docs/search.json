[
  {
    "objectID": "alignment.html",
    "href": "alignment.html",
    "title": "\n4  Alignment\n",
    "section": "",
    "text": "library(tidyverse)\nlibrary(FNN)\nlibrary(parallel)\n\n# Set the parameter range and resolution based on experience.\nmoveplain &lt;- expand_grid(\n  a = seq(0.9,1.1,0.01),\n  b = seq(0.9,1.1,0.01),\n  x0 = seq(-10,10,3),\n  y0 = seq(-10,10,3),\n  eta = seq(0, 3.14, 0.01)\n)\n\n\ntissue_rna &lt;- read_csv(input_tissue_pth) |&gt; dplyr::filter(in_tissue == 1)\nX &lt;- tissue_rna[,c(\"col\", \"row\")]\n\n\nmetabolism_matrix_ft &lt;- colSums(metabolism_matrix) &gt; 0\nmetabolism_df &lt;- metabolism_df[metabolism_matrix_ft,]\nmetabolism_matrix &lt;- metabolism_matrix[,metabolism_matrix_ft]\n\nY &lt;- metabolism_df[,c(\"x\", \"y\")]\n# Scale the data size based on experience.\nY$x &lt;- Y$x * 80\nY$y &lt;- Y$y * 80\ntrainX &lt;- function(X, plain){\n  eta &lt;- plain$eta\n  a &lt;- plain$a\n  b &lt;- plain$b\n  x0 &lt;- plain$x0\n  y0 &lt;- plain$y0\n  \n  # Centralization\n  X$col &lt;- X$col - mean(X$col)\n  X$row &lt;- X$row - mean(X$row)\n  \n  # Stretch and pressure\n  X$col &lt;- X$col * a\n  X$row &lt;- X$row * b\n  \n  # Rotate\n  X$col &lt;- X$col * cos(eta) - X$row * sin(eta)\n  X$row &lt;- X$col * sin(eta) + X$row * cos(eta)\n  \n  # Translation\n  X$col &lt;- X$col - x0\n  X$row &lt;- X$row - y0\n  \n  X\n}\n\ndistance_total &lt;- parallel::mclapply(1:nrow(moveplain), function(i){\n  plain &lt;- moveplain[i,]\n  Y_hat &lt;- trainX(X, plain)\n  # k is set based on experience.\n  nnlistab &lt;- FNN::get.knn(Y_hat, Y, k = 5)\n  nnlistba &lt;- FNN::get.knn(Y, Y_hat, k = 5)\n  distance_total &lt;- rowSums(nnlistab$nn.dist) + rowSums(nnlistba$nn.dist)\n  distance_total\n}, mc.cores = 40L) |&gt; unlist()\nmoveplain$distance_total &lt;- distance_total\nbest_plain &lt;- moveplain |&gt; slice_min(order_by = distance_total, n = 1)\nY_hat_best &lt;- trainX(X, best_plain) \n# k is set based on experience.\nY_hat_bestnn &lt;- FNN::get.knn(Y_hat_best, Y, k = 2)\n\n# Generate the metabolome matrix.\ncombined_metabolism &lt;- Y_hat_bestnn$nn.index |&gt; \n  as.data.frame()|&gt; \n  mutate(\n    barcode = tissue_rna$barcode\n  ) |&gt; \n  pivot_longer(- barcode, names_to = \"nst_n\", values_to = \"metabolism_id\") |&gt; \n  left_join(\n    t(metabolism_matrix) |&gt; as.data.frame() |&gt; mutate(metabolism_id = 1:n()) |&gt; \n      pivot_longer(- metabolism_id, names_to = \"ion_peak\", values_to = \"intensity\")\n  ) |&gt; \n  group_by(barcode, ion_peak) |&gt; \n  summarise(intensity = mean(intensity)) |&gt; \n  pivot_wider(id_cols = ion_peak, names_from = barcode, values_from = intensity) |&gt; \n  column_to_rownames(var = ion_peak) |&gt; \n  as.matrix()",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Alignment</span>"
    ]
  }
]