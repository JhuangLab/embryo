[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Spatiotemporal Metabolic Atlas of Mammalian Organogenesis",
    "section": "",
    "text": "Preface\nOrganogenesis in mammals involves a highly orchestrated series of spatially and temporally regulated cellular processes. These processes are tightly coupled to transcriptional networks and metabolic pathways, but how these factors cooperately drive complex morphogenesis remains poorly understood. Here, we constructed spatiotemporal transcriptional networks and a comprehensive metabolic atlas to delineate the dynamic metabolic landscape during organogenesis. Integrated analysis revealed that each organ acquired specific metabolic features, with the liver and brain exhibiting particularly pronounced specifications. This organ-specific metabolism emerges progressively from an initially homogeneous metabolic pattern distributed across the entire embryo. Within the organs, we identified a series of spatially organized metabolic patterns, gradients or niches in the developing somite or brain, which were often aligned with signaling pathways or cell fate transitions. Comparative analysis of mouse and human embryo organ development demonstrated that mouse embryos, undergo more rapid organ-level metabolic specification than human embryos, consistent with their developmental pace.\nCollectively, these findings highlight the spatiotemporal heterogeneity of organ-level metabolism and underscore the fundamental roles of metabolic specification in mammalian organogenesis.",
    "crumbs": [
      "Preface"
    ]
  },
  {
    "objectID": "welcome.html",
    "href": "welcome.html",
    "title": "Welcome",
    "section": "",
    "text": "Reproducible research\nAnother goal of this book is to help readers to make our result reproducible. The hope is to get readers can reproduce most of our results. For genomics and bioinformatics specialists, we prioritize reproducibility. A companion book will accompany the article, detailing bioinformatics workflows, including data preprocessing, analytical pipelines, software versions, and parameter settings. This resource ensures transparency and enables precise replication of our computational methods.\nBy addressing these diverse audiences, our work bridges clinical practice, computational reproducibility, and mechanistic research, advancing the diagnosis, treatment, and understanding of multiple myeloma in Chinese populations.",
    "crumbs": [
      "Welcome"
    ]
  },
  {
    "objectID": "intro.html",
    "href": "intro.html",
    "title": "Introduction",
    "section": "",
    "text": "To begin, I assume that you have read through our paper. In the chapters of this book, I present the key components of this study, encompassing the full analytical workflow from data collection to result interpretation. Particular emphasis is placed on the major findings of the research. I hope this book offers useful insights for readers and also contributes, in a small way, to the broader reproducibility community.",
    "crumbs": [
      "Introduction"
    ]
  },
  {
    "objectID": "datasets.html",
    "href": "datasets.html",
    "title": "1  Data collection",
    "section": "",
    "text": "1.1 Data sets\nData sets were newly curated for the current study and originates from both mouse and human embryos. Murine samples were collected at E9.5 (n = 3), E11.5 (n = 2), and E13.5 (n = 2) from pregnant females. The collection and use of human embryos, which obtained from women who voluntarily terminated their pregnancies in this study were approved by the Clinical Research Ethics Committee of the First Affiliated Hospital of Zhejiang University. Based on size and anatomical characteristics, human embryos were staged as CS12, CS14, CS16, and CS18. And only one sample was representative for each stage.\nAfter frozen sectioning, serial slides from target embryos were collected and one section stained with hematoxylin and eosin (H&E). Slides approximating the midsagittal plane were mounted onto 10 × Genomics Visium array slides (6.5 × 6.5 mm or 11 × 11 mm area) for spatially resolved transcriptomics with Visium platform following the manufacturer’s instructions outlined in the user guides. Another 2 adjacent sections were mounted onto Superfrost Plus slides (Citotest) for AFADESI-MSI, with vacuum-dried at first. Raw data were converted to the standard ‘.imzML’ format using the imzMLConverter software and ion identification was conducted with pySM framework. Spatial transcriptomics and metabolomics data were gained from Ouyi Biological Company. Tissue annotations were manually performed using graphical user interface of Loupe Browser (v8) according to morphological structure from H&E and transcript features of unsupervised clustering.\nAdditionally, a single-nucleus RNA sequencing dataset (GSE186069) was downloaded from GEO database with its associated annotations, to characterize cell composition within embryonic sample spots.",
    "crumbs": [
      "Data Collection",
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Data Sets</span>"
    ]
  },
  {
    "objectID": "reduce_dim.html",
    "href": "reduce_dim.html",
    "title": "\n4  Dimensionality Reduction\n",
    "section": "",
    "text": "4.1 PCA figure",
    "crumbs": [
      "Unsupervised cluster",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Reduce Dim</span>"
    ]
  },
  {
    "objectID": "reduce_dim.html#pca-figure",
    "href": "reduce_dim.html#pca-figure",
    "title": "\n4  Dimensionality Reduction\n",
    "section": "",
    "text": "PCA plot .",
    "crumbs": [
      "Unsupervised cluster",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Reduce Dim</span>"
    ]
  },
  {
    "objectID": "reduce_dim.html#tsne-figure",
    "href": "reduce_dim.html#tsne-figure",
    "title": "\n4  Dimensionality Reduction\n",
    "section": "\n4.2 tSNE figure",
    "text": "4.2 tSNE figure\n\n\ntSNE plot.",
    "crumbs": [
      "Unsupervised cluster",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Reduce Dim</span>"
    ]
  },
  {
    "objectID": "reduce_dim.html#umap-figure",
    "href": "reduce_dim.html#umap-figure",
    "title": "\n4  Dimensionality Reduction\n",
    "section": "\n4.3 UMAP figure",
    "text": "4.3 UMAP figure\n\n\nUMAP plot after batch correction.\n\n\n\n\nPCA plot .\ntSNE plot.\nUMAP plot after batch correction.",
    "crumbs": [
      "Unsupervised cluster",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Reduce Dim</span>"
    ]
  },
  {
    "objectID": "drug.html",
    "href": "drug.html",
    "title": "\n5  Treatment status in this study\n",
    "section": "",
    "text": "5.1 Treatment response groups and related functions\nWe applied consistent criteria to classify treatment responses in both the CoMMpass and Jilin datasets. Patients were grouped into seven response categories: stringent complete response (sCR), complete response (CR), very good partial response (VGPR), partial response (PR), minimal response (MR), stable disease (SD), and progressive disease (PD). For analysis, we designated sCR and CR as the best response group, and SD and PD as the poor response group, aiming to exclude ambiguous responses and maximize the contrast between the two groups for the identification of potentially response-associated biological functions.\nsinfo_pionly_fil &lt;- sinfo_pionly[sinfo_pionly$best_response %in% c(\"sCR\", \"CR\", \"SD\", \"PD\"), ]\nsinfo_pionly_fil$group &lt;- ifelse(sinfo_pionly_fil$best_response %in% c(\"sCR\", \"CR\"), \"best\", \"worst\")\ncounts_pionly_fil &lt;- counts_merged[, sinfo_pionly_fil$sample_id]\n\n\ndds_pi_part &lt;- DESeqDataSetFromMatrix(counts_pionly_fil, sinfo_pionly_fil, ~ rna_type + group)\nkeep &lt;- rowSums(counts(dds_pi_part) &gt;= 5) &gt; ceiling(0.2 * ncol(dds_pi_part))  \ndds_pi_part &lt;- dds_pi_part[keep, ]\nkeep2 &lt;- rowSums(counts(dds_pi_part) == 0) &lt; ceiling(0.5 * ncol(dds_pi_part))\ndds_pi_part &lt;- dds_pi_part[keep2, ]\ndds_pi_part &lt;- DESeq(dds_pi_part)\n\n\nres_pi_part &lt;- add_col(results(dds_pi_part, c(\"group\", \"worst\", \"best\")))\nres_pi_part_fil &lt;- as.data.frame(res_pi_part)[res_pi_part$pvalue &lt; 0.05, ] %&gt;% na.omit()\nGSEAinput_pi2 &lt;- res_pi_part$log2FoldChange\nnames(GSEAinput_pi2) &lt;- as.character(rownames(res_pi_part))\nGSEAinput_pi2 &lt;- sort(GSEAinput_pi2, decreasing = TRUE)\ngseGOres_pi2_part &lt;- gseGO(GSEAinput_pi2, OrgDb = org.Hs.eg.db, keyType = \"SYMBOL\", ont = \"BP\",\n                           minGSSize = 5, maxGSSize = 200, pvalueCutoff = 0.2)\n\n\n# use batch-corrected exp data (limma)\nmm1330 &lt;- read_rds(\"~/projects/mm/analysis/meta/human/rnaseq/exp/mm1330.rds\") \nexp_mm &lt;- mm1330[, -2] %&gt;% left_join(hugo_anno) %&gt;% na.omit() %&gt;% \n  dplyr::select(-c(gene_id, locus_group)) %&gt;% as.data.frame() %&gt;% remove_rownames() %&gt;% \n  column_to_rownames(var = \"symbol\") %&gt;% as.matrix()\nexp_pi_part &lt;- exp_mm[, sinfo_pionly_fil$sample_id]\npi_group_part &lt;- factor(sinfo_pionly_fil$group)\nfit &lt;- lmFit(exp_pi_part, model.matrix(~ pi_group_part))\nfit &lt;- eBayes(fit)\nresults_pi_part &lt;- add_col2(topTable(fit, coef = 2, number = Inf, adjust.method = \"BH\"))\nresults_pi_part_fil &lt;- results_pi_part[results_pi_part$P.Value &lt; 0.05, ]\n\nGSEA_input_pi_limma &lt;- results_pi_part$logFC\nnames(GSEA_input_pi_limma) &lt;- as.character(rownames(results_pi_part))\nGSEA_input_pi_limma &lt;- sort(GSEA_input_pi_limma, decreasing = TRUE)\ngseGO_res_pi_part_limma &lt;- gseGO(GSEA_input_pi_limma, OrgDb = org.Hs.eg.db, keyType = \"SYMBOL\", ont = \"BP\",\n                                 minGSSize = 5, maxGSSize = 200, pvalueCutoff = 0.2)\nGiven the presence of batch effects and underlying subtype heterogeneity, we first assessed the impact of potential confounding factors by applying two complementary approaches: DESeq2 (correcting for sequencing platform only) and limma (applied to expression data with batch effects removed). Functional analysis of the resulting differential expression outputs revealed highly concordant results between the two methods, suggesting that batch effects and subtype differences had limited impact under these conditions.\nccres &lt;- compareCluster(geneCluster = list(pi_deseq2 = GSEAinput_pi2, pi_limma = GSEA_input_pi_limma, \n                                           tri_deseq2 = GSEAinput_tri, tri_limma = GSEA_input_tri2_limma),\n                        fun = gseGO, OrgDb = org.Hs.eg.db, keyType = \"SYMBOL\", ont = \"BP\",\n                        minGSSize = 4, maxGSSize = 200, pvalueCutoff = 0.1)\npdf(\"four_comp.pdf\", width = 8, height = 10)\ndotplot(ccres)\ndev.off()\nWe next included the IMiD-based samples in our analysis and compared the resulting functional enrichment outcomes. Notably, sister chromatid separation consistently emerged as one of the most significantly enriched biological processes. This result was further validated using the Jilin dataset independently, indicating that this pathway exhibits robust differences across datasets and treatment regimens. Aberrations in sister chromatid separation can lead to aneuploidy, a hallmark of MM, and may offer insights into mechanisms of drug resistance.\nSubsequently, we investigated gene expression patterns associated with treatment response.\n# match gene expression pattern to drug response groups\nexp_resp &lt;- exp_mm[, resp_fil$sample_id]\ny7 &lt;- resp_fil$group\ntrend_p &lt;- apply(exp_resp, 1, \\(g) cor.test(g, as.numeric(y7), method = \"spearman\")$p.value )\ncand_genes &lt;- names(head(sort(trend_p), 200))\n\n# plot\nresp_colors &lt;- c(\"sCR\" = \"#F4E0FA\", \"CR\" = \"#E4E2F8\", \"VGPR\" = \"#9163C1\", \"PR\" = \"#F6D7ED\",\n                 \"MR\" = \"#FEF2F2\", \"SD\" = \"#F7F2FE\", \"PD\" = \"#E0ECFA\")\ntreat_colors &lt;- RColorBrewer::brewer.pal(4, \"Set1\")\nexp_long &lt;- exp_resp %&gt;% as.data.frame() %&gt;% rownames_to_column(\"gene\") %&gt;%\n  pivot_longer(-gene, names_to = \"sample_id\", values_to = \"expression\")\nplot_data &lt;- left_join(exp_long, resp_fil)\nNo single gene was found to be strongly correlated with drug response. While certain genes showed modest expression trends corresponding to treatment efficacy, these patterns were insufficient to support predictive use. An example of such gene-level expression is illustrated below:\ncand_gene &lt;- \"CPSF7\"\n gene_df &lt;- plot_data[plot_data$gene %in% cand_gene, ]\n  p &lt;- ggplot(gene_df, aes(x = group, y = expression)) +\n    geom_boxplot(aes(fill = group), outlier.shape = NA, alpha = 0.7) +\n    geom_jitter(aes(color = treatment_group), width = 0.2, size = 1.5) +\n    scale_fill_manual(values = resp_colors) +\n    scale_color_manual(values = treat_colors) +\n    labs(title = cand_gene, x = NULL, y = \"Expression\") +\n    theme_cowplot() +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1))\n  ggsave(paste0(\"exp_plots/boxplot_\", cand_gene, \".pdf\"), plot = p, width = 6, height = 4)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Treatment Response</span>"
    ]
  },
  {
    "objectID": "drug.html#treatment-response-groups-and-related-functions",
    "href": "drug.html#treatment-response-groups-and-related-functions",
    "title": "\n5  Treatment status in this study\n",
    "section": "",
    "text": "Functional differences between worst and best responders.\n\n\n\n\nConsistent functional differences across individual datasets.\n\n\n\n\n\n\n\nExample gene with expression changes.\n\n\n\n\nFunctional differences between worst and best responders.\nConsistent functional differences across individual datasets.\nExample gene with expression changes.",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Treatment Response</span>"
    ]
  },
  {
    "objectID": "mmyelomap.html",
    "href": "mmyelomap.html",
    "title": "\n6  The MMyeloMap R package\n",
    "section": "",
    "text": "To distill the key patterns embedded in the large-scale transcriptomic dataset generated in this study and to support downstream research, we developed multiple predictive models based on diverse machine learning algorithms. These models were trained on the integrated dataset described in this work. To assess their performance and identify the most reliable classifier for subtype prediction, we incorporated an independent external cohort and processed it using the same analytical pipeline. Predictions from each model were compared against subtype assignments derived from standard clustering procedures. This comparison enabled the identification of the optimal model, which demonstrated high predictive accuracy. Building on these results, we assembled a suite of molecular profiling tools for multiple myeloma (MM), which have been packaged into an R toolkit, MMyeloMap, supporting comprehensive, single-sample subtype inference.\nBy using expression quantification results generated via Salmon as input, a comprehensive sample prediction report can be obtained by running the following code. Selected components of the report are illustrated in the subsequent sections:\n\nlibrary(MMyeloMap)\ntestpath &lt;- path_package(\"MMyeloMap\", \"extdata/files/quant.sf.gz\")\nfs::dir_create(\"test\")\ngenerate_qmd_from_template(testpath,\n                           \"pmm03\", \n                           \"test/out.qmd\")\n\nBased on transcriptomic features, predicted subtypes were inferred and visualized using an interpolated heatmap, as shown below:\n\n\nInterpolated heatmap of newly added sample\n\nThe UMAP visualization of the sample distribution is shown below, with the queried sample marked by a cross (✕):\n\n\nUMAP visualization of new sample\n\nThe following figure displays the key features contributing to the relapse prediction model:\n\n\nSubtype prediction of new sample\n\nIn addition to analyzing differences between primary and relapsed samples (see the DEG section for example), we also aimed to predict the future risk of relapse using baseline transcriptomic features. Known samples were split into training and testing sets to train a predictive model. The example code and resulting performance are shown below:\n\npkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\",\n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \n          \"SummarizedExperiment\", \"jhuanglabRNAseq\", \"DESeq2\", \"maftools\", \n          \"matrixStats\", \"Matrix\", \"furrr\", \"ComplexHeatmap\", \"caret\", \n          \"glmnet\", \"pROC\", \"ranger\")\nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n} \n\n# load data\nsetwd(\"/cluster/home/yjliu_jh/projects/mm/output/relapse_prediction\")\nmerged_sinfo &lt;- read_rds(\"~/projects/mm/docs/meta/sampleinfo/sampleinfo_jilin_commpass.rds\")\nmm1330 &lt;- read_rds(\"~/projects/mm/analysis/meta/human/rnaseq/exp/mm1330.rds\") \n\n# load new gene symbol info \nhugo_anno &lt;- readr::read_delim(\"/cluster/home/yjliu_jh/projects/mm/data/hgnc_complete_set.txt\",\n                               col_types = cols(intermediate_filament_db = col_character()))\nhugo_anno &lt;- hugo_anno[, c(\"symbol\", \"ensembl_gene_id\", \"locus_group\")] %&gt;% as.data.frame() \ncolnames(hugo_anno)[2] &lt;- \"gene_id\"\nexp_mm &lt;- mm1330[, -2] %&gt;% left_join(hugo_anno) %&gt;% na.omit() %&gt;% \n  dplyr::select(-c(gene_id, locus_group)) %&gt;% as.data.frame() %&gt;% remove_rownames() %&gt;% \n  column_to_rownames(var = \"symbol\") %&gt;% as.matrix()\n\n# select primary samples and divide them based on recurrence\nsinfo_commpass &lt;- merged_sinfo[merged_sinfo$batch %in% \"commpass\", ]\nsinfo_commpass$patient_id &lt;- substr(sinfo_commpass$sample_id, 1, 9)\nsinfo_c_fil &lt;- sinfo_commpass[!grepl(\"PB\", sinfo_commpass$sample_id), ]\ndup_patients &lt;- intersect(sinfo_c_fil$patient_id[sinfo_c_fil$tumor_descriptor %in% c(\"primary\", \"Primary\")], sinfo_c_fil$patient_id[sinfo_c_fil$tumor_descriptor %in% \"recurrence\"])\nsinfo_commpass2 &lt;- sinfo_c_fil[sinfo_c_fil$patient_id %in% dup_patients, c(\"sample_id\", \"patient_id\", \"tumor_descriptor\")]\nsinfo_commpass2 &lt;- sinfo_commpass2[sinfo_commpass2$tumor_descriptor %in% \"primary\", ]\n\nsinfo_jilin &lt;- merged_sinfo[merged_sinfo$batch %in% \"jilin\", c(\"sample_id\", \"cn_name\", \"tumor_descriptor\")] %&gt;% unique()\nsinfo_jilin2 &lt;- sinfo_jilin[sinfo_jilin$tumor_descriptor %notin% \"initial_treating\", ]\ntemp_count &lt;- sinfo_jilin2 %&gt;% group_by(cn_name) %&gt;% summarise(c = length(unique(tumor_descriptor)))\ntemp_patients &lt;- temp_count$cn_name[temp_count$c &gt; 1]\nsinfo_jilin2 &lt;- sinfo_jilin2[sinfo_jilin2$cn_name %in% temp_patients & sinfo_jilin2$tumor_descriptor %in% \"primary\", ]\nsinfo_jilin3 &lt;- sinfo_jilin2[!duplicated(sinfo_jilin2[, 2:3]), ] %&gt;% as.data.frame()\nsinfo_jilin3 &lt;- sinfo_jilin3[order(sinfo_jilin3$cn_name, sinfo_jilin3$tumor_descriptor), ]\njilin_extra &lt;- anti_join(sinfo_jilin2, sinfo_jilin3)$sample_id\n\nextra_set &lt;- merged_sinfo$sample_id[merged_sinfo$datasets %in% \"EGAD00001007813\" & merged_sinfo$tumor_descriptor %in% \"primary\"]\n\n# set metadata\nall_relapse_samples &lt;- c(sinfo_commpass2$sample_id, sinfo_jilin3$sample_id, extra_set)\nsinfo_fil &lt;- merged_sinfo[merged_sinfo$datasets %in% c(\"jilin\", \"commpass\", \"EGAD00001007813\") & merged_sinfo$tumor_descriptor %in% c(\"primary\", \"Primary\"), ]\nsinfo_fil &lt;- sinfo_fil[sinfo_fil$sample_id %in% colnames(mm1330), ]\nsinfo_fil$relapse_status &lt;- ifelse(sinfo_fil$sample_id %in% c(all_relapse_samples, jilin_extra), \"relapse\", \"non-relapse\")\n\n# === RF model ===\n\nrelapse_samples &lt;- sample(sinfo_fil$sample_id[sinfo_fil$relapse_status %in% \"relapse\"], 72)\nremaining_samples &lt;- c(setdiff(all_relapse_samples, relapse_samples), jilin_extra)\nall_baseline_samples &lt;- setdiff(sinfo_fil$sample_id, c(all_relapse_samples, jilin_extra))\nbaseline_samples &lt;- sample(all_baseline_samples, 800)\nremaining_baseline &lt;- setdiff(all_baseline_samples, baseline_samples)\n\nexp_mm_fil &lt;- exp_mm[, c(baseline_samples, relapse_samples)]\nexp_mm_fil &lt;- as.data.frame(exp_mm_fil) %&gt;% dplyr::arrange(desc(rowVars(exp_mm_fil)))\nhvg &lt;- rownames(exp_mm_fil)[1:750]\nexp_diff &lt;- rowMeans(exp_mm_fil[, baseline_samples]) - rowMeans(exp_mm_fil[, relapse_samples])\ndfg &lt;- names(tail(sort(abs(exp_diff)), 250))\n\nnames_info &lt;- data.frame(ori_names = rownames(exp_mm))\nnames_info$new_names &lt;- colnames(janitor::clean_names(t(exp_mm)))\n\nexp_t &lt;- as.data.frame(t(exp_mm_fil[unique(c(hvg, dfg)), ]))\nexp_t$sample_id &lt;- rownames(exp_t)\nexpr_cols &lt;- setdiff(colnames(exp_t), \"sample_id\")\n# covariates &lt;- c(\"subtypes\", \"age\", \"gender\", \"Clinical_IgH\", \"iss_stage\")  \n# feature_cols &lt;- c(expr_cols, covariates)    ## doesn't work after tests, remove for convenience\nfeature_cols &lt;- expr_cols\n\ndata_all &lt;- left_join(exp_t, sinfo_fil[, c(\"sample_id\", \"relapse_status\")], by = \"sample_id\")\nx &lt;- data_all[, feature_cols]\ny &lt;- as.factor(data_all$relapse_status)\nx &lt;- janitor::clean_names(x)\n\nrf_model &lt;- ranger::ranger(  ## may go further on parameter selection\n  formula = relapse_status ~ .,\n  data = cbind(relapse_status = y, x),\n  probability = TRUE,               \n  importance = \"impurity\", ## based on Gini impurity \n  num.trees = 2000\n)\n\n# test_other &lt;- merged_sinfo$sample_id[merged_sinfo$datasets %in% \"bmc\" & merged_sinfo$tumor_descriptor %in% \"primary\"] %&gt;% sample(10)\nexp_new &lt;- exp_mm[, intersect(c(remaining_samples, remaining_baseline), colnames(exp_mm))]\n\nexp_new_t &lt;- as.data.frame(t(exp_new))\nexp_new_t$sample_id &lt;- rownames(exp_new_t)\nexp_new_t &lt;- left_join(exp_new_t, merged_sinfo[, c(\"sample_id\", covariates)], by = \"sample_id\")\nexp_new_t &lt;- janitor::clean_names(exp_new_t)\n\nnew_pred &lt;- predict(rf_model, data = exp_new_t)$predictions\ny_new &lt;- sinfo_fil$relapse_status[match(colnames(exp_new), sinfo_fil$sample_id)]\n\ncbind(new_pred, y_new)\nroc_obj &lt;- roc(factor(y_new), new_pred[, 1])\n\n\n\npdf(\"rf_test.pdf\", width = 5, height = 4)\nplot(roc_obj, print.auc = TRUE, main = \"Relapse Prediction ROC\")\ndev.off()\n\nvarimp &lt;- sort(rf_model$variable.importance, decreasing = TRUE)\ntop_features &lt;- head(varimp, 30)\nnames(top_features) &lt;- names_info$ori_names[match(names(head(varimp, 30)), names_info$new_names)]\n\n\npdf(\"rf_top_features.pdf\", width = 7, height = 6)\nggplot(data.frame(Feature = names(top_features), Importance = top_features),\n       aes(x = reorder(Feature, Importance), y = Importance)) +\n  geom_col(fill = \"steelblue\") +\n  coord_flip() +\n  labs(title = \"Top 30 Important Features\", x = \"\", y = \"Importance\")\ndev.off()\n\nThe ROC visualization:\n\n\nSubtype prediction of new sample\n\nTop genes contributing to the prediction model:\n\n\nSubtype prediction of new sample\n\n\n\n\nInterpolated heatmap of newly added sample\nUMAP visualization of new sample\nSubtype prediction of new sample\nSubtype prediction of new sample\nSubtype prediction of new sample",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>The Mmyelomap R package</span>"
    ]
  },
  {
    "objectID": "fig1.html",
    "href": "fig1.html",
    "title": "\n7  Figure 1\n",
    "section": "",
    "text": "7.1 Figure 1",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig1.html#figure-1",
    "href": "fig1.html#figure-1",
    "title": "\n7  Figure 1\n",
    "section": "",
    "text": "7.1.1 Refined\nThe document is self-contained: it installs missing packages (if running on a local machine), loads data, generates all panels, and writes the final PDFs to the working directory that is automatically created. Below is the code generating Figure 1:\n\n# Install any missing packages automatically -----------------------------\npkgs &lt;- c(\n  \"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\",\n  \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\",\n  \"paletteer\", \"cowplot\", \"ComplexHeatmap\", \"circlize\", \"plot1cell\"\n)\nto_install &lt;- pkgs[!pkgs %in% installed.packages()[, \"Package\"]]\nif (length(to_install)) install.packages(to_install, repos = \"https://cloud.r-project.org\")\n\n# Load all packages quietly ---------------------------------------------\nsuppressPackageStartupMessages(lapply(pkgs, library, character.only = TRUE))\n\nproject  &lt;- \"collabrators\"\ndataset  &lt;- \"wangwenjie\"\nspecies  &lt;- \"mouse\"\n\nworkdir  &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/fig1\")\nfs::dir_create(workdir)\nsetwd(workdir)\n\nyaml_fn  &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\n\n# Retrieve colour palettes from YAML -------------------------------------\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"tissue\")\nstg_cols    &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"stage\")\n\n# Shared ggplot theme -----------------------------------------------------\nmy_theme1 &lt;- theme_classic(base_size = 8) +\n  theme(\n    legend.key.size = unit(3, \"mm\"),\n    axis.text       = element_text(color = \"black\"),\n    axis.ticks      = element_line(color = \"black\"),\n    plot.title      = element_text(hjust = 0.5)\n  )",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig2.html",
    "href": "fig2.html",
    "title": "\n8  Figure 2\n",
    "section": "",
    "text": "8.1 Figure 2",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Figure 2</span>"
    ]
  },
  {
    "objectID": "fig2.html#figure-2",
    "href": "fig2.html#figure-2",
    "title": "\n8  Figure 2\n",
    "section": "",
    "text": "8.1.1 Load Required Packages\n\n# List of required packages\npkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"paletteer\", \"cowplot\", \"ComplexHeatmap\", \"circlize\")\n\n# Load each package silently\nfor (pkg in pkgs) {\n  suppressPackageStartupMessages(library(pkg, character.only = TRUE))\n}\n\n\n8.1.2 Set Project Variables and Working Directory\n\n# Define project, dataset, and species\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\n\n# Create and set working directory\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/fig2\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\n# Load YAML configuration file for colors\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"tissue\")\nstg_cols &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"stage\")[c(\"E9.5\", \"E11.5\", \"E13.5\")]\n\n# Define custom theme for plots\nmy_theme1 &lt;- theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"), \n        axis.ticks = element_line(color = \"black\"), plot.title = element_text(hjust = 0.5))\n\n\n8.1.3 Figure 2a-c: Specific m/z Expression in Selected Tissues Across Stages\nThis section generates heatmaps showing specific m/z expression in selected mouse tissues for each developmental stage.\n\n# Load metabolite information from KEGG\nmtb_info &lt;- read_rds(\"~/ref/kegg/mouse/mmu_mtb_pth_cpd.rds\")\n\n# Load qualitative data from Excel file\nxlsx_fn1 &lt;- glue(\"/cluster/home/jhuang/projects/collabrators/data/wangwenjie/mouse/metabolism/mouse_adjusted/DZLM2023110146_DZLM2024030584-b1-张进-王文杰-空间代谢组-项目报告/2.定性结果/Qualitative.xlsx\")\nneg_anot1 &lt;- readxl::read_excel(xlsx_fn1, sheet = \"neg-all\") %&gt;% \n  mutate(mz_id = paste0(\"neg-\", mz)) %&gt;% dplyr::filter(KEGG %in% mtb_info$cpd_id, !is.na(Metabolites))\npos_anot1 &lt;- readxl::read_excel(xlsx_fn1, sheet = \"pos-all\") %&gt;% \n  mutate(mz_id = paste0(\"pos-\", mz)) %&gt;% dplyr::filter(KEGG %in% mtb_info$cpd_id, !is.na(Metabolites))\nanot1 &lt;- rbind(neg_anot1, pos_anot1)\nanot2 &lt;- anot1 %&gt;% dplyr::filter(KEGG %in% mtb_info$cpd_id)\n\n# Define sample names and tissue orders for each stage\nsamples &lt;- c(\"E95\", \"E115\", \"E135\")\n\nord_e95 &lt;- c(\"Forebrain\",\"Midbrain\",\"Hindbrain\",\"Spinal cord\",\"Caudal neuropore\",\n             \"Branchial arch\",\"Somite\",\"Heart\",\"AGM\",\"Mesenchyme\",\"Liver\",\"Lung\",\n             \"Gut\",\"Cavity\")\nord_e115 &lt;- c(\"Forebrain\", \"Midbrain\", \"Hindbrain\", \"Spinal cord\", \"Epidermis\", \n              \"Branchial arch\", \"Jaw and tooth\", \"Forelimb\", \"Hindlimb\", \"Somite\", \n              \"Heart\", \"AGM\", \"Liver\", \"Gut\", \"Cavity\", \"Embryo membrane\")\nord_e135 &lt;- c(\"Forebrain\", \"Midbrain\", \"Hindbrain\", \"Diencephalon\", \"Spinal cord\", \n              \"Epidermis\", \"Ear\", \"Jaw and tooth\", \"Hindlimb\", \"Cartilage\", \"Muscle\", \n              \"Heart\", \"Blood vessel\", \"Gonad\", \"Kidney\", \"Liver\", \"Lung\", \"Gut\")\nord_lst &lt;- list(E95 = ord_e95, E115 = ord_e115, E135 = ord_e135)\n\n# Load normalized data\nrds_fn1 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig2ac_mouse_mz_htp_dat_norm_lst.rds\"\ndat_norm_lst &lt;- read_rds(rds_fn1)\n\n# Generate heatmaps for each sample\nfor(samp in samples) {\n  dat_norm = dat_norm_lst[[samp]][, ord_lst[[samp]]]\n  lvls &lt;- colnames(dat_norm)\n  \n  # Prepare right annotation for metabolites\n  nm &lt;- rownames(dat_norm)\n  tst1 = rbind(neg_anot1, pos_anot1) %&gt;% dplyr::filter(mz_id %in% nm) %&gt;%\n    dplyr::select(all_of(c(\"mz_id\", \"Metabolites\"))) %&gt;% dplyr::distinct() %&gt;%\n    dplyr::group_by(mz_id) %&gt;% \n    summarise(meta = paste0(Metabolites, collapse = \"; \")) \n  mz_idx &lt;- which(nm %in% tst1$mz_id)\n  lab_mks &lt;- tst1 %&gt;% as.data.frame() %&gt;% column_to_rownames(\"mz_id\") %&gt;% \n    .[nm[mz_idx], ] %&gt;% str_wrap(., width = 30)\n  right_anot1 &lt;- rowAnnotation(link = anno_mark(at = mz_idx,\n                                                labels = lab_mks,\n                                                labels_gp = gpar(fontsize = 4),\n                                                link_width = unit(5, \"mm\"),\n                                                link_height = unit(0.2, \"mm\")))\n  \n  # Prepare top annotation for tissues\n  top_anot11 &lt;- \n    ComplexHeatmap::HeatmapAnnotation(tissue = fct(lvls), show_legend = FALSE, \n                                      show_annotation_name = FALSE, height = unit(1, 'mm'), \n                                      width = unit(60, \"mm\"), \n                                      col = list(tissue = cols_tissue))\n  \n  # Define color function for heatmap\n  col_fun2 &lt;- colorRamp2(c(-3, 0, 3), c(\"lightblue\", \"gray100\", \"#aa3333\"))\n  \n  # Create heatmap\n  htp11 &lt;- ComplexHeatmap::Heatmap(as.matrix(dat_norm),\n                                   top_annotation = top_anot11,\n                                   show_column_names = TRUE,\n                                   show_row_names = FALSE, \n                                   row_names_gp = gpar(fontsize = 2),\n                                   name = \"z-score\",\n                                   show_row_dend = FALSE, \n                                   column_names_gp = gpar(fontsize = 6), \n                                   show_column_dend = FALSE, \n                                   column_names_side = \"top\", column_names_rot = 30, \n                                   right_annotation = right_anot1,\n                                   cluster_columns = FALSE, cluster_rows = FALSE, \n                                   col = col_fun2, \n                                   height = unit(10, \"cm\"), width = unit(6, \"cm\")\n  )\n  \n  # Save heatmap to PDF\n  pdf(glue(\"fig2ac_mz_top15_heatmap_{samp}_v2.pdf\"), width = 4.5, height = 6)\n  print(htp11)\n  dev.off()\n}\n\n\n8.1.4 Figure 2d: Spatial Distribution of Selected Tissues\nThis section generates spatial plots showing the distribution of selected tissues in mouse embryos at different stages.\n\n# Load Visium objects\nrds_fn4 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/mmu_visium_obj_lst.rds\"\nmmu_visium_lst = read_rds(rds_fn4)\n\n# Generate spatial plots for each stage\nfor(samp in c(\"E9.5\", \"E11.5\", \"E13.5\")) {\n  obj1 &lt;- mmu_visium_lst[[samp]]\n  sel_tissues &lt;- c(\"CNS\", \"Heart\", \"Liver\", \"AGM\")\n  if(samp == \"E9.5\") {\n    scale_fct &lt;- 1.6\n    plot_width &lt;- 2\n    plot_height &lt;- 2\n  } else if (samp == \"E11.5\") {\n    scale_fct &lt;- 1.1\n    plot_width &lt;- 4\n    plot_height &lt;- 4\n  } else {\n    scale_fct &lt;- 2.0\n    plot_width &lt;- 6\n    plot_height &lt;- 6\n    sel_tissues[4] &lt;- \"G and K\"\n  }\n  plst1 &lt;- lapply(sel_tissues, \\(sel) {\n    obj1$labels_plot &lt;- case_when(obj1$labels_fig2d %in% sel ~ sel, TRUE ~ \"others\")\n    Seurat::SpatialDimPlot(obj1, group.by = \"labels_plot\", label = FALSE, \n                           pt.size = scale_fct, image.alpha = 0, stroke = NA, \n                           cols = c(cols_tissue[sel], \"gray99\")) & \n      my_theme1 & labs(title = sel) & Seurat::NoLegend() & \n      theme(plot.title = element_text(size = 8), plot.margin = margin(c(0, 0, 0, 0), unit = \"cm\")) & \n      Seurat::NoAxes() & coord_fixed()\n  })\n  fig2d &lt;- plst1 %&gt;% patchwork::wrap_plots(nrow = 1)\n  ggsave(glue(\"fig2d_mouse_spatial_tissue_{samp}_v250322.pdf\"), fig2d, \n         width = plot_width * 4, height = plot_height, units = \"cm\")\n}\n\n\n8.1.5 Figure 2g: Metabolite Changes in Liver Across Stages\nThis section creates line plots showing changes in metabolite abundance in the liver across developmental stages.\n\n# Load long format fold change data\ncsv_fn1 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig2g_mouse_mz_liver_long_fc.csv\"\nlong_fc &lt;- read_csv(csv_fn1) %&gt;% mutate(name = fct(as.character(name), levels = paste0(\"E\", c(9.5, 11.5, 13.5))))\n\n# Create line plot\nline1 = ggplot2::ggplot(long_fc, aes(x = name, y = value, group = feature, color = group)) + \n  ggplot2::geom_line() + scale_color_manual(values = unname(cols_tissue[1:6])) + \n  ggplot2::facet_wrap(~ group, ncol = 3) + my_theme1 + \n  theme(legend.position = \"none\", axis.line = element_blank(), \n        panel.border = element_rect(fill = NA, color = \"black\", linewidth = 0.5)) + \n  labs(x = \"\", y = \"Relative abundance\")\n\n# Save plot to PDF\nggsave(\"fig2g_liver_mtb_line1.pdf\", line1, width = 6, height = 3)\n\n\n8.1.6 Figure 2h: Moran’s I Changes Across Stages\nThis section generates line plots for Moran’s I trends in different tissues.\n\n# Load Moran's I data\ncsv_fn2 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig2h_mouse_mz_moran_trends.csv\"\noutcsv &lt;- read_csv(csv_fn2)\n\n# Function to draw line plots for Moran's I\ndraw_line &lt;- function(outcsv){\n  sigtissue &lt;- outcsv  %&gt;%\n    dplyr::select(feature, anot1) %&gt;%\n    dplyr::distinct() %&gt;%\n    group_by(anot1) %&gt;%\n    summarise(n = n()) %&gt;%\n    group_by(anot1) %&gt;%\n    dplyr::filter(anot1 != \"others\") %&gt;%\n    arrange(desc(n)) %&gt;%\n    pull(anot1)\n  outcsv %&gt;% \n    dplyr::filter(anot1 != \"others\") %&gt;%\n    mutate(anot1 = factor(anot1, levels = sigtissue)) %&gt;% \n    ggplot(aes(x = name, y = value, group = feature, color = anot1)) +\n    geom_line() + scale_color_manual(values = cols_tissue) + \n    facet_wrap(~anot1) +\n    ylab(label = \"Moran's Index\") +\n    xlab(label = \"Stage\") +\n    my_theme1 +\n    theme(legend.position = \"none\", axis.line = element_blank(), \n          panel.border = element_rect(linewidth = 0.5, fill = NA, color = \"black\"),  \n          axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5))\n}\n\n# Save plot to PDF\npdf(glue(\"./fig2h_mz_moran_trend_tissue.pdf\"))\ndraw_line(outcsv)\ndev.off()\n\n\n8.1.7 Figure 2i: Bar Plot of Metabolite Counts per Tissue\nThis section creates a bar plot showing the number of metabolites per tissue.\n\n# Function to draw bar plot\ndraw_bar &lt;- function(outcsv){\n  outcsv  %&gt;% \n    dplyr::select(feature, anot1) %&gt;% \n    dplyr::distinct() %&gt;% \n    group_by(anot1) %&gt;% \n    summarise(n = n()) %&gt;% \n    arrange(desc(n)) %&gt;% \n    mutate(label = factor(anot1, levels = anot1)) %&gt;% \n    ggplot(aes(x = label, y = n, fill = label)) + \n    geom_bar(stat = \"identity\") +\n    my_theme1 + scale_fill_manual(values = cols_tissue) + \n    theme(legend.position = \"none\", \n          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0)) + \n    labs(x = \"\", y = \"Metabolite Number\")\n}\n\n# Save plot to PDF\npdf(glue(\"./fig2i_mouse_mz_num_tissue.pdf\"))\ndraw_bar(outcsv)\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Figure 2</span>"
    ]
  },
  {
    "objectID": "fig3.html",
    "href": "fig3.html",
    "title": "\n9  Figure 3\n",
    "section": "",
    "text": "9.1 Figure 3",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Figure 3</span>"
    ]
  },
  {
    "objectID": "fig3.html#figure-3",
    "href": "fig3.html#figure-3",
    "title": "\n9  Figure 3\n",
    "section": "",
    "text": "9.1.1 \ncode:\n\npkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"paletteer\", \"cowplot\", \"ComplexHeatmap\", \"circlize\")  \nfor (pkg in pkgs) {\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/fig3\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"tissue\")\n\nmy_theme1 &lt;- theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"), \n        axis.ticks = element_line(color = \"black\"), plot.title = element_text(hjust = .5))\n\n## fig3a-c: human m/z tissue specific markers -----\nmtb_info &lt;- read_rds(\"~/ref/kegg/human/hsa_mtb_pth_cpd.rds\")\nxlsx_fn1 &lt;- \n  glue(\"/cluster/home/jhuang/projects/collabrators/data/wangwenjie/human/metabolism/human_adjusted/DZLM2024030584-b2_DZLM2024030572-张进-王文杰-空间代谢组-项目报告/2.定性结果/Qualitative.xlsx\")\nneg_anot1 &lt;- readxl::read_excel(xlsx_fn1, sheet = \"neg-all\") %&gt;% \n  mutate(mz_id = paste0(\"neg-\", mz)) %&gt;% dplyr::filter(KEGG %in% mtb_info$cpd_id, !is.na(Metabolites))\npos_anot1 &lt;- readxl::read_excel(xlsx_fn1, sheet = \"pos-all\") %&gt;% \n  mutate(mz_id = paste0(\"pos-\", mz)) %&gt;% dplyr::filter(KEGG %in% mtb_info$cpd_id, !is.na(Metabolites))\n\nsamples &lt;- c(\"yao1\", \"yao2\", \"yao5\")\n\nord_yao1 &lt;- c(\"Forebrain\", \"Midbrain\", \"Hindbrain\", \"Spinal cord\", \"Optic vesicle\", \n              \"Jaw and tooth\", \"Branchial arch\", \"Somite\", \"Heart\", \"Liver\", \"Gut\", \n              \"Embryo membrane\")\nord_yao2 &lt;- c(\"Forebrain\", \"Midbrain\", \"Hindbrain\", \"Spinal cord\", \"Optic vesicle\", \n              \"Jaw and tooth\", \"Branchial arch\", \"Somite\", \"Heart\", \"AGM\", \"Liver\", \n              \"Lung\", \"Gut\", \"Umbilical cord\")\nord_yao5 &lt;- c(\"Forebrain\",\"Midbrain\",\"Hindbrain\",\"Diencephalon\",\"Spinal cord\",\"Ear\", \n              \"Jaw and tooth\",\"Forelimb\",\"Hindlimb\",\"Cartilage\",\"Muscle\",\"Heart\", \n              \"Blood vessel\",\"Liver\",\"Gut\")\nord_lst &lt;- list(yao1 = ord_yao1, yao2 = ord_yao2, yao5 = ord_yao5)\n\nrds_fn3 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig3ac_human_mz_dat_norm_lst.rds\"\ndat_norm_lst &lt;- read_rds(rds_fn3)\nfor(samp in samples) {\n  dat_norm = dat_norm_lst[[samp]]\n  lvls &lt;- colnames(dat_norm)\n  ## right anot ----\n  nm &lt;- rownames(dat_norm)\n  tst1 = rbind(neg_anot1, pos_anot1) %&gt;% dplyr::filter(mz_id %in% nm) %&gt;%\n    dplyr::select(all_of(c(\"mz_id\", \"Metabolites\"))) %&gt;% dplyr::distinct() %&gt;%\n    dplyr::group_by(mz_id) %&gt;% \n    summarise(meta = paste0(Metabolites, collapse = \"; \")) \n  mz_idx &lt;- which(nm %in% tst1$mz_id)\n  lab_mks &lt;- tst1 %&gt;% as.data.frame() %&gt;% column_to_rownames(\"mz_id\") %&gt;% \n    .[nm[mz_idx], ] %&gt;% str_wrap(., width = 30)\n  right_anot1 &lt;- rowAnnotation(link = anno_mark(at = mz_idx,\n                                                labels = lab_mks,\n                                                labels_gp = gpar(fontsize = 6),\n                                                link_width = unit(3, \"mm\"),\n                                                link_height = unit(.05, \"mm\")))\n  top_anot11 &lt;- \n    ComplexHeatmap::HeatmapAnnotation(tissue = fct(lvls), show_legend = F, \n                                      show_annotation_name = F, \n                                      col = list(tissue = cols_tissue))\n  \n  col_fun2 &lt;- colorRamp2(c(-3, 0, 3), c(\"lightblue\", \"gray100\", \"#aa3333\"))\n  \n  htp11 &lt;- ComplexHeatmap::Heatmap(as.matrix(dat_norm),\n                                   top_annotation = top_anot11,\n                                   show_column_names = T,\n                                   show_row_names = F, \n                                   row_names_gp = gpar(fontsize = 3),\n                                   name = \"z-score\",\n                                   show_row_dend = F, \n                                   column_names_gp = gpar(fontsize = 6), \n                                   show_column_dend = F, \n                                   column_names_side = \"top\", column_names_rot = 30, \n                                   right_annotation = right_anot1,\n                                   cluster_columns = F, cluster_rows = F, \n                                   col = col_fun2, \n                                   height = unit(10, \"cm\"), width = unit(6, \"cm\")\n  )\n  pdf(glue(\"fig3ac_mz_top15_heatmap_{samp}_v250322.pdf\"), width = 5, height = 5)\n  print(htp11)\n  dev.off()\n}\n\n## fig3d: human selected tissue specific spatial distribution -----\nrds_fn4 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/human_visium_all_gene_lst.rds\"\nhsa_visium_lst = read_rds(\"../rds/human_visium_all_gene_lst.rds\")\nnames(hsa_visium_lst) &lt;- c(\"CS12\", \"CS14\", \"CS18\")\n\nfor(samp in c(\"CS12\", \"CS14\", \"CS18\")) {\n  obj1 &lt;- hsa_visium_lst[[samp]]\n  if(samp == \"CS12\") {\n    scale_fct &lt;- 1.8\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n  } else if (samp == \"CS14\") {\n    scale_fct &lt;- 1.3\n    plot_width &lt;- 4\n    plot_height &lt;- 4\n  } else {\n    scale_fct &lt;- 1.3\n    plot_width &lt;- 8\n    plot_height &lt;- 8\n  }\n  plst1 &lt;- lapply(c(\"CNS\", \"Heart\", \"Liver\", \"Somite\"), \\(sel) {\n    obj1$labels_plot &lt;- case_when(obj1$labels_fig3d %in% sel ~ sel, TRUE ~ \"others\")\n    Seurat::SpatialDimPlot(obj1, group.by = \"labels_plot\", label = F, \n                           pt.size = scale_fct, image.alpha = 0, stroke = NA, \n                           cols = c(cols_tissue[sel], \"gray99\")) & \n      my_theme1 & labs(title = sel) & Seurat::NoLegend() & \n      theme(plot.title = element_text(size = 8), plot.margin = margin(c(0, 0, 0, 0), unit = \"cm\")) & \n      Seurat::NoAxes() & coord_fixed()\n  })\n  plst1 &lt;- plst1 %&gt;% patchwork::wrap_plots(nrow = 1)\n  ggsave(glue(\"fig3d_human_spatial_tissue_{samp}_v250322.pdf\"), plst1, \n         width = plot_width * 4, height = plot_height, units = \"cm\")\n}\n\n## fig3g: changes among stages of human metabolites in liver -----\ncsv_fn1 &lt;- \"/cluster/home/ztao_jh/projects/embryo/analysis/zhangjing/human/rnaseq/new_label/ren_time_point_2/neg/Liver.csv\"\nlog_fc &lt;- read_csv(csv_fn1)\nlog_fc &lt;- log_fc %&gt;% \n  mutate(stage = case_when(grepl(\"yao1\", name) ~ \"CS12\", grepl(\"yao2\", name) ~ \"CS14\", TRUE ~ \"CS18\")) %&gt;% \n  mutate(stage = fct(as.character(stage), levels = paste0(\"CS1\", c(2, 4, 8)))) %&gt;% \n  dplyr::filter(!grepl(\"Trend7\", group))\n\nline1 = ggplot2::ggplot(log_fc, aes(x = stage, y = value, group = feature, color = group)) + \n  ggplot2::geom_line() + scale_color_manual(values = unname(cols_tissue[1:6])) + \n  ggplot2::facet_wrap(~ group, ncol = 3) + my_theme1 + \n  theme(legend.position = \"none\", axis.line = element_blank(), \n        panel.border = element_rect(fill = NA, color = \"black\", linewidth = .5)) + \n  labs(x = \"\", y = \"Relative abundance\")\nggsave(\"fig3g_liver_mtb_line1.pdf\", line1, width = 6, height = 3)\n\n## fig2h: moran's I changes -----\ncsv_fn2 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig3h_human_mz_moran_trends.csv\"\noutcsv &lt;- read_csv(csv_fn2)\ndraw_line &lt;- function(outcsv){\n  sigtissue &lt;- outcsv  %&gt;%\n    dplyr::select(feature, anot1) %&gt;%\n    dplyr::distinct() %&gt;%\n    group_by(anot1) %&gt;%\n    summarise(n = n()) %&gt;%\n    group_by(anot1) %&gt;%\n    dplyr::filter(anot1 != \"others\") %&gt;%\n    arrange(desc(n)) %&gt;%\n    pull(anot1)\n  outcsv %&gt;% \n    dplyr::filter(anot1 != \"others\") %&gt;%\n    mutate(anot1 = factor(anot1, levels = sigtissue)) %&gt;% \n    ggplot(aes(x = stage, y = value, group = feature, color = anot1)) +\n    geom_line() + scale_color_manual(values = cols_tissue) + \n    facet_wrap(~anot1) +\n    ylab(label = \"Moran's Index\") +\n    xlab(label = \"Stage\") +\n    my_theme1 +\n    theme(legend.position = \"none\", axis.line = element_blank(), \n          panel.border = element_rect(linewidth = .5, fill = NA, color = \"black\"),  \n          axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5))\n}\npdf(glue(\"./fig3h_mz_moran_trend_tissue.pdf\"))\ndraw_line(outcsv)\ndev.off()\n\n## fig2i: bar plot of each tissue ----\ndraw_bar &lt;- function(outcsv){\n  outcsv  %&gt;% \n    dplyr::select(feature, anot1) %&gt;% \n    dplyr::distinct() %&gt;% \n    group_by(anot1) %&gt;% \n    summarise(n = n()) %&gt;% \n    arrange(desc(n)) %&gt;% \n    mutate(label = factor(anot1, levels = anot1)) %&gt;% \n    ggplot(aes(x = label, y = n, fill = label)) + \n    geom_bar(stat = \"identity\") +\n    my_theme1 + scale_fill_manual(values = cols_tissue) + \n    theme(legend.position = \"none\", \n          axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) + \n    labs(x = \"\", y = \"Metabolite Number\")\n}\npdf(glue(\"./fig3i_human_mz_num_tissue.pdf\"))\ndraw_bar(outcsv)\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Figure 3</span>"
    ]
  },
  {
    "objectID": "faq.html",
    "href": "faq.html",
    "title": "10  Frequently Asked Questions",
    "section": "",
    "text": "Frequently Asked Questions",
    "crumbs": [
      "Communication",
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>FAQ</span>"
    ]
  },
  {
    "objectID": "contactus.html",
    "href": "contactus.html",
    "title": "11  Contact us",
    "section": "",
    "text": "We welcome inquiries and collaboration to maximize the impact of our research. To ensure your questions are directed to the most appropriate team member, please use the following contact guidelines:\n\nClinical Questions: For inquiries related to clinical implications, diagnostic applications, or patient management, please contact Prof. Fengyan Jin.\nWet Lab and Experimental Questions: For questions about sample preparation, library preparation, functional assays, or other experimental methodologies, please reach out to Prof. Yun Dai.\nBioinformatics and Computational Questions: For assistance with bioinformatics troubleshooting, methodology, or replicating our analytical pipelines, please contact me directly at hiekeen@gmail.com.\n\nGeneral Inquiries or Collaborative Opportunities: For all other questions, including data access, interdisciplinary collaborations, or feedback on the project, we encourage you to email Prof. Fengyan Jin, Prof. Yun Dai, and me collectively. We are deeply invested in enabling others to explore and build upon this dataset.",
    "crumbs": [
      "Communication",
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>Contact us</span>"
    ]
  },
  {
    "objectID": "functions.html",
    "href": "functions.html",
    "title": "12  Functions",
    "section": "",
    "text": "To summarize the features embedded in the large-scale transcriptomic dataset generated in this study and to facilitate downstream application by other researchers, we trained multiple predictive models using various algorithms, built upon the dataset presented herein. To evaluate model performance and guide the selection of optimal classifiers for robust subtype prediction, a set of external, independent samples was integrated with our cohort and annotated using the same analytical pipeline. These external samples were also used as model input. By comparing the model predictions with the results obtained from the standard analytical pipeline, we identified the optimal model, which achieved a high accuracy.\nSubsequently, in conjunction with the findings of this study, we developed a suite of methods for molecular characterization of multiple myeloma (MM) samples and implemented them in an R package (MMyeloMap) designed to enable comprehensive single-sample prediction. This tool takes transcript quantification results generated by the Salmon pipeline as input and optionally produces a comprehensive web-based report. The framework integrates multiple predictive models trained on multiple cohorts (see Methods), and provides an overall subtype assignment for the queried sample. The output includes figures illustrating transcriptomic clustering characteristics, dimensionality reduction visualizations, and other relevant features. When raw FASTQ files are used as input, the tool can also infer the patient’s immunoglobulin (Ig) isotype and identify potential driver alterations.\nPlease check https://github.com/JhuangLab/MMyeloMap/ and https://jhuanglab.github.io/MMyeloMap for the details.",
    "crumbs": [
      "Appendix",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Functions</span>"
    ]
  },
  {
    "objectID": "acknowledgement.html#note",
    "href": "acknowledgement.html#note",
    "title": "13  Acknowledgement",
    "section": "13.1 Note",
    "text": "13.1 Note\nWe get some colors setting from: https://zhuanlan.zhihu.com/p/693124785.",
    "crumbs": [
      "Appendix",
      "<span class='chapter-number'>13</span>  <span class='chapter-title'>Acknowledgement</span>"
    ]
  },
  {
    "objectID": "final.html",
    "href": "final.html",
    "title": "14  Final Words",
    "section": "",
    "text": "We are deeply grateful for your patience and continued interest as we advance this research on molecular subtyping of multiple myeloma in Chinese patients. This project is an ongoing journey, and we are actively working to refine our analyses, enhance the reproducibility of our computational methods, and uncover new insights into the molecular mechanisms driving this disease. In the coming phases, we plan to share expanded datasets, updated bioinformatics workflows, and novel findings that further elucidate population-specific genetic alterations and their therapeutic implications. These efforts aim to empower clinicians with actionable tools for personalized care, provide bioinformatics specialists with robust, replicable pipelines, and offer oncogenesis researchers deeper mechanistic understanding. Your engagement and feedback are invaluable as we strive to bridge clinical practice, computational science, and oncology research. Stay tuned for updates, and thank you for being part of this collaborative endeavor to improve diagnosis, treatment, and outcomes for multiple myeloma in Chinese and Asian populations.",
    "crumbs": [
      "Appendix",
      "<span class='chapter-number'>14</span>  <span class='chapter-title'>Final Words</span>"
    ]
  },
  {
    "objectID": "fig1.html#figure-1b-mouse-tissue-atlas-visium",
    "href": "fig1.html#figure-1b-mouse-tissue-atlas-visium",
    "title": "\n7  Figure 1\n",
    "section": "\n7.2 Figure 1B – Mouse tissue atlas (VISIUM)",
    "text": "7.2 Figure 1B – Mouse tissue atlas (VISIUM)\n\nrds_fn1   &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/mmu_visium_obj_lst.rds\"\nmmu_visium &lt;- readr::read_rds(rds_fn1)\nsamples_mmu &lt;- c(\"E95\", \"E115\", \"E135\")\n# Generate each spatial panel and save individual PDFs -------------------\nplst1 &lt;- lapply(samples_mmu, \\(samp) {\n  obj1 &lt;- mmu_visium[[samp]]\n\n  # Dynamic sizing per sample\n  if (samp == \"E95\") {\n    scale_fct &lt;- 1.6;  plot_width &lt;- 2; plot_height &lt;- 2\n  } else if (samp == \"E115\") {\n    scale_fct &lt;- 1.1;  plot_width &lt;- 4; plot_height &lt;- 4\n  } else {\n    scale_fct &lt;- 2.0;  plot_width &lt;- 6; plot_height &lt;- 6\n  }\n\n  p &lt;- SpatialDimPlot(obj1,\n                      pt.size.factor = scale_fct,\n                      image.alpha    = 0,\n                      group.by       = \"tissuetype\") &\n       scale_fill_manual(values = cols_tissue) &\n       my_theme1 & NoAxes() & NoLegend()\n\n  ggsave(glue(\"fig1b_mouse_tissuetype_spatial_{samp}.pdf\"), p,\n         width = plot_width, height = plot_height)\n  p\n}) |&gt; setNames(samples_mmu)\n\n\n# Build universal legend -------------------------------------------------\ntbl1 &lt;- bind_rows(lapply(samples_mmu, \\(samp) {\n  tibble(tissuetype = unique(mmu_visium[[samp]]$tissuetype))\n}))\n\npt1 &lt;- ggplot(tbl1, aes(1, tissuetype, color = tissuetype)) +\n  geom_point(size = 0.4) +\n  scale_color_manual(values = cols_tissue) +\n  my_theme1 +\n  coord_fixed() +\n  labs(color = \"\")\n\nlegend &lt;- cowplot::get_legend(pt1)\nplst1[[\"legend\"]] &lt;- cowplot::plot_grid(NULL, legend, NULL,\n                                        ncol = 3, rel_widths = c(.1, 1, .1))\nggsave(\"fig1b_legend_mouse_tissuetype_spatial.pdf\", plst1[[\"legend\"]],\n       width = 2, height = 2)\n\n# Assemble final panel ----------------------------------------------------\nfig1b_mouse &lt;- cowplot::plot_grid(plotlist = plst1, nrow = 1,\n                                  rel_widths = c(.8, 1, 1.2, 1))\nggsave(\"fig1b_mouse_tissuetype.pdf\", fig1b_mouse,\n       width = unit(8, \"cm\"), height = unit(3, \"cm\"))",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig1.html#figure-1c-human-tissue-atlas-visium",
    "href": "fig1.html#figure-1c-human-tissue-atlas-visium",
    "title": "\n7  Figure 1\n",
    "section": "\n7.3 Figure 1C – Human tissue atlas (VISIUM)",
    "text": "7.3 Figure 1C – Human tissue atlas (VISIUM)\n\nsamples_hsa &lt;- c(\"yao1\", \"yao2\", \"yao5\")\nrds_fn2 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/hsa_visium_obj_lst.rds\"\nhsa_visium &lt;- readr::read_rds(rds_fn2)\n\nplst1 &lt;- lapply(samples_hsa, \\(samp) {\n  obj1 &lt;- hsa_visium[[samp]]\n\n  if (samp == \"yao1\") {\n    scale_fct &lt;- 1.8; plot_width &lt;- 2; plot_height &lt;- 2\n  } else if (samp == \"yao2\") {\n    scale_fct &lt;- 1.3; plot_width &lt;- 4; plot_height &lt;- 4\n  } else {\n    scale_fct &lt;- 1.5; plot_width &lt;- 6; plot_height &lt;- 6\n  }\n\n  p &lt;- SpatialDimPlot(obj1,\n                      pt.size.factor = scale_fct,\n                      image.alpha    = 0,\n                      group.by       = \"tissue\") &\n       scale_fill_manual(values = cols_tissue) &\n       my_theme1 & NoAxes() & NoLegend()\n\n  ggsave(glue(\"fig1c_human_tissue_spatial_{samp}.pdf\"), p,\n         width = plot_width, height = plot_height)\n  p\n}) |&gt; setNames(samples_hsa)\n\ntbl1 &lt;- lapply(samples_hsa, \\(samp) {\n  tibble(tissue = unique(hsa_visium[[samp]]$tissue))\n}) |&gt; bind_rows() |&gt; dplyr::distinct()\n\npt1 &lt;- ggplot(tbl1, aes(1, tissue, color = tissue)) +\n  geom_point(size = 0.4) +\n  scale_color_manual(values = cols_tissue) +\n  my_theme1 +\n  coord_fixed() +\n  labs(color = \"\")\n\nlegend &lt;- cowplot::get_legend(pt1)\nplst1[[\"legend\"]] &lt;- cowplot::plot_grid(NULL, legend, NULL,\n                                        ncol = 3, rel_widths = c(.1, 1, .1))\nggsave(\"fig1c_legend_human_tissue_spatial.pdf\", plst1[[\"legend\"]],\n       width = 2, height = 2)\n\n\nfig1c_human &lt;- cowplot::plot_grid(plotlist = plst1, nrow = 1,\n                                  rel_widths = c(.6, 1, 1.2, 1))\nggsave(\"fig1c_human_tissue.pdf\", fig1c_human,\n       width = unit(8, \"cm\"), height = unit(3, \"cm\"))",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig1.html#figure-1d-plot1cell-circle-plots",
    "href": "fig1.html#figure-1d-plot1cell-circle-plots",
    "title": "\n7  Figure 1\n",
    "section": "\n7.4 Figure 1D – plot1cell circle plots",
    "text": "7.4 Figure 1D – plot1cell circle plots\nMouse – all genes\n\nrds_fn4 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/mmu_visium_merged_obj.rds\"\nvisium_mmu_mrg &lt;- readr::read_rds(rds_fn4)\n\ncirc_dat   &lt;- prepare_circlize_data(visium_mmu_mrg, scale = 0.7)\nclust_cols &lt;- cols_tissue[sort(unique(circ_dat$tissuetype))]\nlgd_squre  &lt;- Legend(at = names(stg_cols), type = \"grid\",\n                     legend_gp = gpar(fill = stg_cols),\n                     title_position = \"topleft\", title = \"stage\")\n\npdf(\"fig1d_mouse_plot1cell_all_genes.pdf\", width = 8, height = 8)\nplot_circlize(circ_dat, do.label = TRUE, pt.size = 0.5,\n              col.use = clust_cols, bg.color = \"white\",\n              kde2d.n = 200, repel = TRUE, label.cex = 0.9)\nadd_track(circ_dat, group = \"stage\",\n          colors = stg_cols[order(names(stg_cols))], track_num = 2)\ndraw(lgd_squre, x = unit(40, \"mm\"), y = unit(12, \"mm\"),\n     just = c(\"right\", \"bottom\"))\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig1.html#mouse-metabolic-genes",
    "href": "fig1.html#mouse-metabolic-genes",
    "title": "\n7  Figure 1\n",
    "section": "\n7.5 Mouse – metabolic genes",
    "text": "7.5 Mouse – metabolic genes\n\nrds_fn5 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/mmu_visium_mtb_gene_merged_obj.rds\"\nseu_new3_mrg &lt;- readr::read_rds(rds_fn5)\n\ncirc_dat   &lt;- prepare_circlize_data(seu_new3_mrg, scale = 0.7)\nclust_cols &lt;- cols_tissue[sort(unique(circ_dat$tissuetype))]\n\npdf(\"fig1d_mouse_plot1cell_mtb_genes.pdf\", width = 8, height = 8)\nplot_circlize(circ_dat, do.label = TRUE, pt.size = 0.5,\n              col.use = clust_cols, bg.color = \"white\",\n              kde2d.n = 200, repel = TRUE, label.cex = 0.9)\nadd_track(circ_dat, group = \"stage\", colors = stg_cols, track_num = 2)\ndraw(lgd_squre, x = unit(40, \"mm\"), y = unit(12, \"mm\"),\n     just = c(\"right\", \"bottom\"))\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig1.html#mouse-mz-data",
    "href": "fig1.html#mouse-mz-data",
    "title": "\n7  Figure 1\n",
    "section": "\n7.6 Mouse – M/Z data",
    "text": "7.6 Mouse – M/Z data\n\nrds_fn2 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/mouse_mz_obj_merged.rds\"\nmz_obj_mrg &lt;- readr::read_rds(rds_fn2)\n\ncirc_dat   &lt;- prepare_circlize_data(mz_obj_mrg, scale = 0.7)\nclust_cols &lt;- cols_tissue[sort(unique(circ_dat$tissuetype))]\n\npdf(\"fig1c_plot1cell_all_mz_mrg.pdf\", width = 5.5, height = 5.5)\nplot_circlize(circ_dat, do.label = TRUE, pt.size = 0.4,\n              col.use = clust_cols, bg.color = \"white\",\n              contour.nlevels = 100, kde2d.n = 2000,\n              repel = TRUE, label.cex = 0.7)\nadd_track(circ_dat, group = \"stage\",\n          colors = stg_cols[sort(unique(circ_dat$stage))], track_num = 2)\ndraw(lgd_squre, x = unit(25, \"mm\"), y = unit(8, \"mm\"),\n     just = c(\"right\", \"bottom\"))\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig1.html#human-all-genes",
    "href": "fig1.html#human-all-genes",
    "title": "\n7  Figure 1\n",
    "section": "\n7.7 Human – all genes",
    "text": "7.7 Human – all genes\n\nrds_fn6 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/human_visium_obj_merged.rds\"\nseu_new2_mrg &lt;- readr::read_rds(rds_fn6)\n\ncirc_dat   &lt;- prepare_circlize_data(seu_new2_mrg, scale = 0.7)\nclust_cols &lt;- cols_tissue[sort(unique(circ_dat$tissue))]\n\npdf(\"fig1d_human_plot1cell_all_genes.pdf\", width = 8, height = 8)\nplot_circlize(circ_dat, do.label = TRUE, pt.size = 0.5,\n              col.use = clust_cols, bg.color = \"white\",\n              kde2d.n = 200, repel = TRUE, label.cex = 0.9)\nadd_track(circ_dat, group = \"stage\",\n          colors = stg_cols[order(names(stg_cols))], track_num = 2)\ndraw(lgd_squre, x = unit(40, \"mm\"), y = unit(12, \"mm\"),\n     just = c(\"right\", \"bottom\"))\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig1.html#human-metabolic-genes",
    "href": "fig1.html#human-metabolic-genes",
    "title": "\n7  Figure 1\n",
    "section": "\n7.8 Human – metabolic genes",
    "text": "7.8 Human – metabolic genes\n\nrds_fn8 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/hsa_visium_mtb_gene_merged_obj.rds\"\nseu_new3_mrg &lt;- readr::read_rds(rds_fn8)\n\ncirc_dat   &lt;- prepare_circlize_data(seu_new3_mrg, scale = 0.7)\nclust_cols &lt;- cols_tissue[sort(unique(circ_dat$tissue))]\n\npdf(\"fig1d_human_plot1cell_mtb_genes_merged.pdf\", width = 8, height = 8)\nplot_circlize(circ_dat, do.label = TRUE, pt.size = 0.5,\n              col.use = clust_cols, bg.color = \"white\",\n              kde2d.n = 200, repel = TRUE, label.cex = 0.9)\nadd_track(circ_dat, group = \"stage\",\n          colors = stg_cols[order(names(stg_cols))], track_num = 2)\ndraw(lgd_squre, x = unit(40, \"mm\"), y = unit(12, \"mm\"),\n     just = c(\"right\", \"bottom\"))\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig1.html#human-mz-data",
    "href": "fig1.html#human-mz-data",
    "title": "\n7  Figure 1\n",
    "section": "\n7.9 Human – M/Z data",
    "text": "7.9 Human – M/Z data\n\nrds_fn4 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/human_mz_obj_merged.rds\"\nseu_mrg2 &lt;- readr::read_rds(rds_fn4)\n\ncirc_dat   &lt;- prepare_circlize_data(seu_mrg2, scale = 0.7)\nclust_cols &lt;- cols_tissue[sort(unique(circ_dat$tissue))]\n\npdf(\"fig1d_human_plot1cell_all_mz_mrg.pdf\", width = 5.5, height = 5.5)\nplot_circlize(circ_dat, do.label = TRUE, pt.size = 0.4,\n              col.use = clust_cols, bg.color = \"white\",\n              contour.nlevels = 100, kde2d.n = 2000,\n              repel = TRUE, label.cex = 0.7)\nadd_track(circ_dat, group = \"stage\",\n          colors = stg_cols[sort(unique(circ_dat$stage))], track_num = 2)\ndraw(lgd_squre, x = unit(25, \"mm\"), y = unit(8, \"mm\"),\n     just = c(\"right\", \"bottom\"))\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "sfig11.html",
    "href": "sfig11.html",
    "title": "\n21  sfig11\n",
    "section": "",
    "text": "pkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"viridis\")  \nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/sfig12\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"tissue\")\nstg_cols &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"stage\")[c(\"CS12\", \"CS14\", \"CS18\")]\n\nmy_theme1 &lt;- theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"), \n        axis.line = element_line(color = \"black\"), axis.ticks = element_line(color = \"black\"))\n\n## figS12a: RCTD results1, main types distribution -----\nrds_fn1 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/sfig12a_rctd_res_df_lst1.rds\"\ndf_lst1 &lt;- read_rds(rds_fn1)\nlapply(c(\"E9.5\", \"E11.5\", \"E13.5\"), \\(stg) {\n  if(stg == \"E13.5\") {\n    scl = .5\n    plot_width = 4\n    plot_height = 4\n  } else if (stg == \"E11.5\") {\n    scl = .5\n    plot_width = 4\n    plot_height = 3\n  } else {\n    scl = .8\n    plot_width = 3\n    plot_height = 2.5\n  }\n  hcc2t_ptn_ratio &lt;- df_lst1[[stg]]\n  pie_p &lt;- ggplot2::ggplot() +\n    scatterpie::geom_scatterpie(aes(x = row, y = col), pie_scale = scl, col = NA, data = hcc2t_ptn_ratio, \n                                cols = colnames(hcc2t_ptn_ratio)[-c(1:3)], long_format = F) +\n    ggplot2::theme_void(base_size = 8) + \n    ggsci::scale_fill_igv() + coord_fixed() + \n    theme(legend.key.size = unit(3, \"mm\"), legend.position = \"right\") \n  ggsave(glue(\"sfig12a_rctd_prop_pie_{stg}.pdf\"), pie_p, width = plot_width, height = plot_height)\n})\n\n## figS12b: RCTD results1, detailed types distribution in liver region -----\nrds_fn2 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/sfig12b_liver_rctd_res.rds\"\nrctd_dat &lt;- read_rds(rds_fn2)\npie_p &lt;- ggplot2::ggplot() +\n  scatterpie::geom_scatterpie(aes(x = row, y = col), pie_scale = 1, col = NA, data = rctd_dat, \n                              cols = colnames(rctd_dat)[-c(1:3)], long_format = F) +\n  ggplot2::theme_void(base_size = 6) + \n  ggsci::scale_fill_igv(alpha = .8) + \n  theme(legend.key.size = unit(3, \"mm\"), legend.position = \"right\") \nggsave(glue(\"sfig12b_liver_rctd_prop_pie.pdf\"), pie_p, width = 4, height = 3)\n\n## figS12c: RCTD weights, liver of each stage -----\nrds_fn3 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/sfig12c_visium_lst4.rds\"\nvisium_lst4 &lt;- read_rds(rds_fn3)\np_lst1 &lt;- list()\nfor(feat in sel_types) {\n  plst1 &lt;- lapply(visium_lst4, \\(seu) {\n    if(grepl(\"E9.5\", unique(seu$sample))) {\n      pt_size = 4\n    } else if (unique(seu$sample) == \"E11.5_S3E2\") {\n      pt_size = 3\n    } else if (unique(seu$sample) == \"E11.5_S3E2_2\"){\n      pt_size = 6\n    } else if (unique(seu$sample) == \"E13.5_S1E1_1st\") {\n      pt_size = 3.5\n    } else if (unique(seu$sample) == \"E13.5_S1E1_2nd\") {\n      pt_size = 4.8\n    }\n    feat1 &lt;- Seurat::SpatialFeaturePlot(seu[, !is.na(seu[[feat]])], image.alpha = 0.5, features = feat, \n                                        pt.size.factor = pt_size, stroke = NA, combine = F, crop = T)\n    feat1 &lt;- feat1 %&gt;% lapply(., \\(p) p + Seurat::DarkTheme() + NoGrid() + NoAxes()) %&gt;% \n      patchwork::wrap_plots() &\n      paletteer::scale_fill_paletteer_c(\"grDevices::Viridis\") & \n      theme(legend.position = \"right\", legend.key.size = unit(3, \"mm\"), \n            text = element_text(size = 6)) & \n      labs(title = feat, fill = \"proportion\", x = \"\", y = \"\")\n  })\n  p_lst1[[feat]] &lt;- patchwork::wrap_plots(plst1, nrow = 1)\n}\npdf(\"sfig12c_rctd_proportion_spatial_feats.pdf\", height = 2, width = 8)\nprint(p_lst1)\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>21</span>  <span class='chapter-title'>Sup Figure 11</span>"
    ]
  },
  {
    "objectID": "fig4.html",
    "href": "fig4.html",
    "title": "\n10  fig4\n",
    "section": "",
    "text": "10.1 Figure 4",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Figure 4</span>"
    ]
  },
  {
    "objectID": "fig4.html#figure-4",
    "href": "fig4.html#figure-4",
    "title": "\n10  fig4\n",
    "section": "",
    "text": "10.1.1 \ncode:\n\npkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"paletteer\", \"cowplot\", \"ComplexHeatmap\", \"circlize\", \"parallel\")  \nfor (pkg in pkgs) {\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/fig4\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"tissue\")\nstg_cols &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"stage\")[c(\"E9.5\", \"E11.5\", \"E13.5\")]\n\nmy_theme1 &lt;- theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"), \n        axis.ticks = element_line(color = \"black\"), plot.title = element_text(hjust = .5))\nmy_theme2 &lt;- theme_classic(base_size = 8) + theme(legend.key.size = unit(3, 'mm')) + \n  theme(axis.line = element_blank(), axis.text = element_blank(), plot.title = element_text(hjust = .5), \n        axis.ticks = element_blank(), axis.title = element_blank(), \n        panel.grid = element_blank(), panel.border = element_rect(linewidth = .5, fill = NA)) \n\n# fig4a: mouse regulon activity of scenic -----\nwrite_csv(mouseobj_full_frame, \"../rds/fig4a_tf_mouseobj_full_frame.csv\")\ncsv_fn1 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig4a_tf_mouseobj_full_frame.csv\"\nmouseobj_full_frame &lt;- read_csv(csv_fn1)\nsetis &lt;- c(\"HNF4A(+)\", \"NEUROD2(+)\", \"GATA4(+)\") %&gt;% stringr::str_to_sentence()\nparallel::mclapply(setis, function(seti){\n  p &lt;- mouseobj_full_frame %&gt;%\n    dplyr::filter(name == {{seti}}) %&gt;%\n    ggplot(aes(x = imagecol, y = imagerow, color = value)) +\n    geom_point(size = 0.1) +\n    scale_color_viridis_c() +\n    my_theme1 + \n    facet_wrap(~ tissue, ncol = 3) +\n    coord_fixed() +\n    ggtitle(seti) +\n    Seurat::DarkTheme() + NoGrid() + NoAxes()\n  ggsave(glue(\"./fig4a_mouse_tf_{seti}_v250322.pdf\"), width = 7, height = 3)\n}, mc.cores = 3)\n\n# fig4b: human regulon activity of scenic -----\nsetis &lt;- c(\"HNF4A(+)\", \"NEUROD2(+)\", \"GATA4(+)\")\ncsv_fn2 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig4b_tf_humanobj_full_frame.csv\"\nhumanobj_full_frame = read_csv(csv_fn2)\nparallel::mclapply(setis, function(seti){\n  p &lt;- humanobj_full_frame %&gt;%\n    dplyr::filter(name == {{seti}}) %&gt;%\n    ggplot(aes(x = imagecol, y = imagerow, color = value)) +\n    geom_point(size = 0.01) +\n    scale_color_viridis_c() +\n    my_theme1 + \n    facet_wrap(~ tissue, nrow = 1) +\n    coord_fixed() + \n    ggtitle(seti) + \n    Seurat::DarkTheme() + NoGrid() + NoAxes()\n  ggsave(glue(\"./fig4b_human_tf_{seti}_v250322.pdf\"), width = 7, height = 3, unit = \"in\")\n}, mc.cores = 3)\n\n# fig4g-i: co-occurrence of regulons and metabolic pathway scores, in mouse -----\ntbl1 &lt;- tibble(tf = \"Hnf4a\", metabolic = c(\"Purine metabolism\", \"Pyrimidine metabolism\"))\ntbl2 &lt;- tibble(tf = \"Sox2\", metabolic = c(\"Alanine, aspartate and glutamate metabolism\", \"Sphingolipid metabolism\"))\ntbl3 &lt;- tibble(tf = \"Gata4\", metabolic = c(\"Biosynthesis of unsaturated fatty acids\", \"Citrate cycle (TCA cycle)\"))\ncomp_df &lt;- bind_rows(tbl1, tbl2, tbl3)\n\nrds_fn3 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig4gi_obj_lst_v2.rds\"\nobj_lst &lt;- read_rds(rds_fn3)\nobj1 &lt;- obj_lst[[\"E115\"]]\ncord_df = Seurat::GetTissueCoordinates(obj1) %&gt;% .[colnames(obj1), ] %&gt;% tibble() %&gt;% \n  mutate(x = imagecol, y = -1 * imagerow)\ncord1 &lt;- cbind(cord_df, obj1@meta.data)\n\nplst3 &lt;- lapply(1:nrow(comp_df), \\(idx) {\n  feat1 &lt;- comp_df[[\"tf\"]][idx] %&gt;% as.character() %&gt;% gsub(\" / \", \"_\", x = .)\n  feat2 &lt;- comp_df[[\"metabolic\"]][idx] %&gt;% as.character() %&gt;% gsub(\" / \", \"_\", x = .)\n  df4p &lt;- cord1 %&gt;% dplyr::select(all_of(c(\"x\", \"y\", feat1, feat2))) %&gt;% \n    dplyr::rename(\"feat1\" = feat1, \"feat2\" = feat2) %&gt;% \n    mutate(top = case_when((feat1 &gt; quantile(.$feat1, .85)) & (feat2 &gt; quantile(.$feat2, .85)) ~ \"top 15%\", \n                           TRUE ~ \"no\"))\n  sp1 &lt;- ggplot2::ggplot() + ggplot2::geom_point(\n    data = df4p, aes(x = x, y = y, color = feat1), show.legend = F, \n    alpha = 1, size = .2\n  ) + labs(color = feat1) + \n    scale_color_continuous(low = \"gray90\", high = \"#ff808f\") +\n    my_theme2 + coord_fixed() + \n    labs(title = feat1, color = \"\")\n  sp2 &lt;- ggplot2::ggplot() + ggplot2::geom_point(\n    data = df4p, aes(x = x, y = y, color = feat2), show.legend = F, \n    alpha = 1, size = .2) + labs(color = feat1, color = \"\") + \n    paletteer::scale_color_paletteer_c(\"pals::kovesi.linear_bgy_10_95_c74\") + \n    my_theme2 + coord_fixed() + \n    labs(title = glue(\"{feat2}\"))\n  \n  p &lt;- ggplot2::ggplot() + \n    ggplot2::geom_point(\n      data = df4p, aes(x = x, y = y, color = feat1), show.legend = F, \n      alpha = .5, size = .2\n    ) + labs(color = feat1) + \n    scale_color_continuous(low = \"gray90\", high = \"#ff808f\") +\n    my_theme2 + coord_fixed() + labs(color = \"tf\") + \n    ggnewscale::new_scale_color() + \n    ggplot2::geom_point(\n      data = df4p, aes(color = feat2, x = x, y = y), show.legend = F, \n      alpha = .5, size = .2) + \n    paletteer::scale_color_paletteer_c(\"pals::kovesi.linear_bgy_10_95_c74\") + \n    my_theme2 + coord_fixed() + labs(color = \"metabolic\") + \n    ggnewscale::new_scale_color() + \n    geom_point(data = dplyr::filter(df4p, top == \"top 15%\"), \n               mapping = aes(x = x, y = y, color = top), \n               size = .3, color = \"#f20020\") + coord_fixed()\n  p1 &lt;- p + \n    ggnewscale::new_scale_fill() +\n    ggplot2::stat_density_2d_filled(\n      data = df4p %&gt;% dplyr::filter(top == \"top 15%\"),\n      mapping = aes(fill = ..ndensity.., #alpha = ..ndensity.., \n                    x = x, y = y), alpha = .5, \n      geom = \"raster\", contour = F, show.legend = T\n    ) + \n    ggplot2::scale_fill_gradientn(colors = c(\"white\", \"#F19E62FF\", \"yellow\")) + \n    coord_fixed() + theme(legend.position = \"right\")\n  p2 = p1 + \n    ggnewscale::new_scale_fill() +\n    geom_density_2d(\n      aes(x = x, y = y), \n      data = df4p %&gt;% dplyr::filter(top == \"top 15%\"),\n      contour_var   = \"ndensity\", alpha = .8, \n      show.legend = T, linewidth = .2\n    ) + \n    coord_fixed() + labs(title = \"intersection of top 15%\") + \n    theme(plot.title = element_text(hjust = .5))\n  sp1 + sp2 + p2 + patchwork::plot_layout(ncol = 3, width = c(1, 1, 1))\n\n})\npdf(glue(\"fig4gi_e115_tf_mz_co_expr.pdf\"), width = 8, height = 3)\nprint(plst3)\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Figure 4</span>"
    ]
  },
  {
    "objectID": "fig5.html",
    "href": "fig5.html",
    "title": "\n11  fig5\n",
    "section": "",
    "text": "pkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"paletteer\", \"cowplot\", \"ComplexHeatmap\", \"circlize\", \"parallel\", \"monocle\")  \nfor (pkg in pkgs) {\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/fig6\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"tissue\")\nstg_cols &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"stage\")[c(\"E9.5\", \"E11.5\", \"E13.5\")]\n\nmy_theme1 &lt;- theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"), \n        axis.ticks = element_line(color = \"black\"), plot.title = element_text(hjust = .5))\nmy_theme2 &lt;- theme_classic(base_size = 8) + theme(legend.key.size = unit(3, 'mm')) + \n  theme(axis.line = element_blank(), axis.text = element_blank(), plot.title = element_text(hjust = .5), \n        axis.ticks = element_blank(), axis.title = element_blank(), \n        panel.grid = element_blank(), panel.border = element_rect(linewidth = .5, fill = NA)) \n\n## fig6b: monocle2 of gene and m/z data ----\nrds_fn1 = \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/align_new/mtb_new/pseudotime_2502011/seu1_brain2.rds\"\nseu1_brain2 = read_rds(rds_fn1)\nfeat1 = Seurat::SpatialFeaturePlot(seu1_brain2, features = \"Pseudotime\", \n                                   pt.size.factor = 1.3, image.alpha = 1) & \n  my_theme1 & coord_fixed() & viridis::scale_fill_viridis()\nggsave(\"fig6b_gene_pseudotime_spatial.pdf\", feat1, width = 4, height = 2)\nrds_fn2 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/align_new/mtb_new/pseudotime_2502011/monocle2_cds_vld_2e-1.rds\"\ncds_vld_gene &lt;- read_rds(rds_fn2)\ncds_vld_gene$Pseudotime &lt;- seu1_brain2$Pseudotime\np_traj1 &lt;- plot_cell_trajectory(cds_vld_gene, color_by = \"Pseudotime\", cell_size = 5e-1) + \n  theme_classic(base_size = 8) + viridis::scale_color_viridis() + \n  theme(legend.position = \"right\", legend.key.size = unit(3, \"mm\")) + ggplot2::coord_fixed()\nggsave(glue::glue(\"fig6b_pseudotime_monocle2_gene.pdf\"), p_traj1, \n       width = 4, height = 2)\n\n### cds object, m/z based -----\nrds_fn3 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/align_new/mtb_new/pseudotime_2502011/cds_vld_mz.rds\"\ncds_vld_mz &lt;- read_rds(rds_fn3)\np_traj2 &lt;- plot_cell_trajectory(cds_vld_mz, color_by = \"Pseudotime\", cell_size = 5e-1) + \n  theme_classic(base_size = 8) + viridis::scale_color_viridis() + \n  theme(legend.position = \"right\", legend.key.size = unit(3, \"mm\")) + ggplot2::coord_fixed()\nggsave(glue::glue(\"fig6b_pseudotime_monocle2_mz.pdf\"), p_traj2, \n       width = 4, height = 2)\n\nrds_fn4 = \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig6b_mz_seu_obj.rds\"\nmz_brain = read_rds(rds_fn4)\nfeat2 = Seurat::SpatialFeaturePlot(mz_brain, features = \"Pseudotime\", \n                                   pt.size.factor = 1.3) & \n  my_theme1 & coord_fixed() & viridis::scale_fill_viridis()\nggsave(\"fig6b_mz_pseudotime_spatial.pdf\", feat2, width = 4, height = 2)\n\n## fig6g: signaling and mtb pathway co-occurrence -----\ncomp_df &lt;- tibble(signaling = \"Notch signaling pathway\", \n                  metabolic = c(\"Glycolysis / Gluconeogenesis\", \"Alanine, aspartate and glutamate metabolism\", \n                                \"Sphingolipid metabolism\"))\nrds_fn3 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig4gi_obj_lst_v2.rds\"\nobj_lst &lt;- read_rds(rds_fn3)\nplst3 &lt;- list()\nfor(samp in c(\"E115\", \"E135\")) {\n  obj1 &lt;- obj_lst[[samp]]\n  if(samp == \"E115\") {\n    cord_df = Seurat::GetTissueCoordinates(obj1) %&gt;% .[colnames(obj1), ] %&gt;% tibble() %&gt;% \n      mutate(x = imagecol, y = -1 * imagerow)\n  } else {\n    cord_df = Seurat::GetTissueCoordinates(obj1) %&gt;% .[colnames(obj1), ] %&gt;% tibble() %&gt;% \n      mutate(x = -1 * imagecol, y = imagerow)\n    \n  }\n  \n  cord1 &lt;- cbind(cord_df, obj1@meta.data)\n  \n  plst3[[samp]] &lt;- lapply(1:nrow(comp_df), \\(idx) {\n    feat1 &lt;- comp_df[[\"signaling\"]][idx] %&gt;% as.character() \n    feat2 &lt;- comp_df[[\"metabolic\"]][idx] %&gt;% as.character() \n    df4p &lt;- cord1 %&gt;% dplyr::select(all_of(c(\"x\", \"y\", feat1, feat2))) %&gt;% \n      dplyr::rename(\"feat1\" = feat1, \"feat2\" = feat2) %&gt;% \n      mutate(top = case_when((feat1 &gt; quantile(.$feat1, .85)) & (feat2 &gt; quantile(.$feat2, .85)) ~ \"top 15%\", \n                             TRUE ~ \"no\"))\n    p &lt;- ggplot2::ggplot() + \n      ggplot2::geom_point(\n        data = df4p, aes(x = x, y = y, color = feat1), show.legend = F, \n        alpha = .5, size = .2\n      ) + labs(color = feat1) + \n      scale_color_continuous(low = \"gray90\", high = \"#ff808f\") +\n      my_theme2 + coord_fixed() + labs(color = \"signaling\") + \n      ggnewscale::new_scale_color() + \n      ggplot2::geom_point(\n        data = df4p, aes(color = feat2, x = x, y = y), show.legend = F, \n        alpha = .5, size = .2) + \n      paletteer::scale_color_paletteer_c(\"pals::kovesi.linear_bgy_10_95_c74\") + \n      my_theme2 + coord_fixed() + labs(color = \"metabolic\") + \n      ggnewscale::new_scale_color() + \n      geom_point(data = dplyr::filter(df4p, top == \"top 15%\"), \n                 mapping = aes(x = x, y = y, color = top), \n                 size = .3, color = \"#f20020\") + coord_fixed()\n    p1 &lt;- p + \n      ggnewscale::new_scale_fill() +\n      ggplot2::stat_density_2d_filled(\n        data = df4p %&gt;% dplyr::filter(top == \"top 15%\"),\n        mapping = aes(fill = ..ndensity.., #alpha = ..ndensity.., \n                      x = x, y = y), alpha = .5, \n        geom = \"raster\", contour = F, show.legend = T\n      ) + \n      ggplot2::scale_fill_gradientn(colors = c(\"white\", \"#F19E62FF\", \"yellow\")) + \n      coord_fixed() + theme(legend.position = \"right\")\n    p2 = p1 + \n      ggnewscale::new_scale_fill() +\n      geom_density_2d(\n        aes(x = x, y = y), \n        data = df4p %&gt;% dplyr::filter(top == \"top 15%\"),\n        contour_var = \"ndensity\", alpha = .8, \n        show.legend = T, linewidth = .2\n      ) + \n      coord_fixed() + labs(title = glue(\"{feat1}\\n&\\n{feat2}\")) + \n      theme(plot.title = element_text(hjust = .5))\n    \n  })\n}\nfig6g &lt;- (plst3[[1]][[1]] | plst3[[2]][[1]])/(plst3[[1]][[2]] | plst3[[2]][[2]]) / (plst3[[1]][[3]] | plst3[[2]][[3]])\npdf(glue(\"fig6g_e115_e135_signal_mz_co_expr.pdf\"), width = 7, height = 11)\n  print(fig6g)\ndev.off()\n\n\n.libPaths(new = c(.libPaths(), \"/cluster/home/danyang_jh/sbin/R/R-4.3.0\"))\npkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"paletteer\", \"cowplot\", \"ComplexHeatmap\", \"circlize\", \"parallel\", \"FELLA\")  \nfor (pkg in pkgs) {\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/fig5\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"tissue\")\nstg_cols &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"stage\")[c(\"E9.5\", \"E11.5\", \"E13.5\")]\n\nmy_theme1 &lt;- theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"), \n        axis.ticks = element_line(color = \"black\"), plot.title = element_text(hjust = .5))\nmy_theme2 &lt;- theme_classic(base_size = 8) + theme(legend.key.size = unit(3, 'mm')) + \n  theme(axis.line = element_blank(), axis.text = element_blank(), plot.title = element_text(hjust = .5), \n        axis.ticks = element_blank(), axis.title = element_blank(), \n        panel.grid = element_blank(), panel.border = element_rect(linewidth = .5, fill = NA)) \n\n## fig5b-f: m/z changes of somite among the trends from anterior to posterior ------\nrds_fn1 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/align_new/mtb_new/pseudotime/cds_vld.rds\"\ncds_vld = read_rds(rds_fn1)\np3 &lt;- monocle::plot_cell_trajectory(cds_vld, cell_size= .2, color_by = \"Pseudotime\") + \n  theme_classic(base_size= 8) + \n  theme( legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\")) + \n  coord_fixed() + viridis::scale_color_viridis()\ncds_vld$subarea = as.character(as.numeric(cds_vld$snn_res.0.6) + 1)\np4 &lt;- monocle::plot_cell_trajectory(cds_vld, cell_size= .2, color_by = \"subarea\") + \n  theme_classic(base_size= 8) + \n  theme( legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\")) + \n  coord_fixed()\nggsave(\"fig5b_ddrtree_dimplot.pdf\", p4 / p3, width = 4, height = 3)\n\nrds_fn1 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/align_new/mtb_new/pseudotime/seu_mz_somite.rds\"\nseu_somite = read_rds(rds_fn1)\nseu_somite$subarea = seu_somite$snn_res.0.6 %&gt;% as.numeric() %&gt;% as.character() %&gt;% fct() %&gt;% \n  fct_recode(\"1\" = '5', \"2\" = \"2\", \"3\" = \"4\", \"4\" = \"3\", \"5\" = \"1\", \"6\" = \"6\") %&gt;% as.character()\nwrite_rds(seu_somite, \"../rds/fig5b_mouse_e11.5_mz_seu_somite.rds\")\nsp1 = Seurat::SpatialDimPlot(seu_somite, group.by = 'subarea', pt.size.factor = 2,\n                             label = T, label.size = 2, label.color = \"black\", label.box = F,\n                             repel = T) & \n  theme_classic(base_size= 8) & labs(title = \"The subarea of E11.5 somite\") &\n  theme( legend.key.size = unit(3, \"mm\")) & coord_fixed()\nggsave(\"fig5c_spatial_dimplot.pdf\", sp1, width = 4, height = 3)\nrds_fn2 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig5d_mouse_e11.5_gene_seu1_somite2.rds\"\nseu1_somite2 &lt;- read_rds(rds_fn2)\nseu1_somite2$Pseudotime = cds_vld$Pseudotime\n\np1 = Seurat::DimPlot(seu_somite, reduction= \"pca\", group.by= \"subarea\", pt.size = .01,\n                     label = T, label.size = 2, label.color = \"black\", label.box = F,\n                     repel = T) +\n  theme_classic(base_size= 8) + labs(title = \"subarea: m/z\") +\n  theme( legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"))\nggsave(\"tst_p1.pdf\", p1, width = 3, height = 3)\np2 = Seurat::DimPlot(seu1_somite2, reduction= \"pca\", group.by= \"subarea\",\n                     pt.size = .01, label = T, label.size = 2, label.color = \"black\", label.box = F,\n                     repel = T) +\n  theme_classic(base_size= 8) + labs(title = \"subarea: visium\") +\n  theme( legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"))\np11 &lt;- Seurat::FeaturePlot(seu_somite, features = \"Pseudotime\", pt.size = .01, reduction = \"pca\") + \n  theme_classic(base_size= 8) + labs(title = \"Pseudotime: m/z\") + \n  theme( legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\")) + \n  viridis::scale_color_viridis()\np21 &lt;- Seurat::FeaturePlot(seu1_somite2, features = \"Pseudotime\", pt.size = .01, reduction = \"pca\") + \n  theme_classic(base_size= 8) + labs(title = \"Pseudotime: visium\") + \n  theme( legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\")) + \n  viridis::scale_color_viridis()\np_comb = p2 + p1 + p21 + p11 + patchwork::plot_layout(nrow = 2)\nggsave(\"fig5d_pca_gene_mz.pdf\", p_comb, width = 6, height = 6)\n\n## fig5e: cluster of m/z trend -----\npseudotime &lt;- cds$Pseudotime %&gt;% setNames(nm = colnames(cds)) %&gt;% sort()\nmz_dat &lt;- cds@assayData$exprs[, names(pseudotime)]\n\nmz_idx &lt;- rowSums(mz_dat) &gt; 0\ntmp &lt;- mz_dat[mz_idx, ]\n\npt.matrix &lt;- tmp\npt.matrix &lt;- t(apply(pt.matrix,1,function(x){smooth.spline(x,df=3)$y}))\npt.matrix &lt;- t(apply(pt.matrix,1,function(x){(x-mean(x))/sd(x)}))\n\ncm &lt;- clusterData(exp = pt.matrix,\n                  cluster.method = \"mfuzz\", \n                  cluster.num = 6,\n                  seed = 42)\nsel_mz &lt;- cm$long.res %&gt;% .$gene %&gt;% unique()\nmz_info &lt;- tibble(mode = str_sub(sel_mz, end = 3), mz = str_sub(sel_mz, start = 5)) %&gt;% \n  mutate(mz_id = paste0(mode, \"-\", sprintf(as.numeric(mz), fmt = \"%.5f\"))) %&gt;% \n  left_join(x = ., y = anot_all, by = c(\"mz_id\" = \"mz_id\", \"mode\" = \"mode\", \"mz\" = \"mz\"))\nwrite_tsv(mz_info, \"trends_mz_info.tsv\")\n\npdf(\"fig5e_pseudotime_mz_heatmap.pdf\", width = 8, height = 10, onefile = FALSE)\nvisCluster(object = cm,\n           plot.type = \"both\",\n           show_row_dend = F,                \n           column_names_rot = 45,             \n           annnoblock.text = F,               \n           ctAnno.col = unname(cols_tissue[1:6]),  \n           sample.order = colnames(pt.matrix)\n) \ndev.off()\n\n## fig5f: cluster1 of m/z trends enrichment -----\nxlsx_fn5 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/align_new/mtb_new/pseudotime_250116/mz_6trends/fella_enrich_up_res_moran_cluster 1.xlsx\"\nenrich_res &lt;- readxl::read_xlsx(xlsx_fn5, sheet = 3)\n\nbar1 &lt;- enrich_res %&gt;% head(n = 10) %&gt;% .[-c(3, 4, 6, 9), ] %&gt;% \n  dplyr::arrange(p.value) %&gt;% mutate(KEGG.name = fct(KEGG.name)) %&gt;% \n  ggplot(aes(x = -log10(p.value), y = KEGG.name)) + \n  geom_bar(fill = cols_tissue[1], stat = \"identity\") + \n  my_theme1 + ggplot2::scale_y_discrete(label = function(x) stringr::str_wrap(x, width = 30)) + \n  labs(title = \"Cluster 1\", y = \"\") + \n  theme(legend.position = \"none\")\nggsave(\"fig5f_mz_cluster1_enrichment.pdf\", bar1, width = 8, height = 4, unit = \"cm\")\n  \n## fig5h: spatial co-occurrence of signaling pathways and metabolic pathways -----\nrds_fn8 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig4gi_obj_lst_v2.rds\"\nobj_lst &lt;- read_rds(rds_fn8)\nobj1 &lt;- obj_lst[[\"E115\"]]\ncord_df = Seurat::GetTissueCoordinates(obj1) %&gt;% .[colnames(obj1), ] %&gt;% tibble() %&gt;% \n  mutate(x = imagecol, y = -1 * imagerow)\ncord1 &lt;- cbind(cord_df, obj1@meta.data)\ncomp_df &lt;- tibble(signaling = c(\"Fgf-Erk signaling pathway\"), \n                  metabolic = c(\"Glycolysis / Gluconeogenesis\", \"Purine metabolism\", \n                                \"Pyrimidine metabolism\"))\nplst3 &lt;- lapply(1:nrow(comp_df), \\(idx) {\n  feat1 &lt;- comp_df[[\"signaling\"]][idx] %&gt;% as.character() #%&gt;% gsub(\" / \", \"_\", x = .)\n  feat2 &lt;- comp_df[[\"metabolic\"]][idx] %&gt;% as.character() #%&gt;% gsub(\" / \", \"_\", x = .)\n  df4p &lt;- cord1 %&gt;% dplyr::select(all_of(c(\"x\", \"y\", feat1, feat2))) %&gt;% \n    dplyr::rename(\"feat1\" = feat1, \"feat2\" = feat2) %&gt;% \n    mutate(top = case_when((feat1 &gt; quantile(.$feat1, .85)) & (feat2 &gt; quantile(.$feat2, .85)) ~ \"top 15%\", \n                           TRUE ~ \"no\"))\n  p &lt;- ggplot2::ggplot() + \n    ggplot2::geom_point(\n      data = df4p, aes(x = x, y = y, color = feat1), show.legend = F, \n      alpha = .5, size = .2\n    ) + labs(color = feat1) + \n    scale_color_continuous(low = \"gray90\", high = \"#ff808f\") +\n    my_theme2 + coord_fixed() + labs(color = \"signaling\") + \n    ggnewscale::new_scale_color() + \n    ggplot2::geom_point(\n      data = df4p, aes(color = feat2, x = x, y = y), show.legend = F, \n      alpha = .5, size = .2) + \n    paletteer::scale_color_paletteer_c(\"pals::kovesi.linear_bgy_10_95_c74\") + \n    my_theme2 + coord_fixed() + labs(color = \"metabolic\") + \n    ggnewscale::new_scale_color() + \n    geom_point(data = dplyr::filter(df4p, top == \"top 15%\"), \n               mapping = aes(x = x, y = y, color = top), \n               size = .3, color = \"#f20020\") + coord_fixed()\n  p1 &lt;- p + \n    ggnewscale::new_scale_fill() +\n    ggplot2::stat_density_2d_filled(\n      data = df4p %&gt;% dplyr::filter(top == \"top 15%\"),\n      mapping = aes(fill = ..ndensity.., #alpha = ..ndensity.., \n                    x = x, y = y), alpha = .5, \n      geom = \"raster\", contour = F, show.legend = T\n    ) + \n    ggplot2::scale_fill_gradientn(colors = c(\"white\", \"#F19E62FF\", \"yellow\")) + \n    coord_fixed() + theme(legend.position = \"right\")\n  p2 = p1 + \n    ggnewscale::new_scale_fill() +\n    geom_density_2d(\n      aes(x = x, y = y), \n      data = df4p %&gt;% dplyr::filter(top == \"top 15%\"),\n      contour_var   = \"ndensity\", alpha = .8, \n      show.legend = T, linewidth = .2\n    ) + \n    coord_fixed() + labs(title = glue(\"{feat1}\\n&\\n{feat2}\")) + \n    theme(plot.title = element_text(hjust = .5))\n return(p2)\n  \n}) %&gt;% patchwork::wrap_plots(ncol = 1)\npdf(glue(\"fig5h_e115_signal_mtb_path_co_expr.pdf\"), width = 3, height = 10)\nprint(plst3)\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>Figure 5</span>"
    ]
  },
  {
    "objectID": "sfig1.html",
    "href": "sfig1.html",
    "title": "\n12  sfig1\n",
    "section": "",
    "text": "pkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"paletteer\", \"cowplot\", \"ComplexHeatmap\", \"circlize\", \"plot1cell\")  \nfor (pkg in pkgs) {\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/figS1\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"tissue\")\nstg_cols &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"stage\") %&gt;% .[c(\"E9.5\", \"E11.5\", \"E13.5\")] \n\n## figS1c: plot1cell, umap + outer circle -----\nmmu_visium_lst &lt;- list()\nfor(idx in c(\"E9.5\", \"E11.5\", \"E13.5\")){\n  # intersect_mtb_genes &lt;- intersect(rownames(seu_lst3[[idx]]), mmu_mtb_genes)\n  obj1 &lt;- seu_lst3[[idx]]\n  obj1 &lt;- obj1 %&gt;% Seurat::SCTransform(assay = \"Spatial\") %&gt;%\n    Seurat::RunPCA(npcs = 100) %&gt;% Seurat::RunUMAP(dims = 1:30) %&gt;% Seurat::RunTSNE(dims = 1:10) %&gt;%\n    Seurat::FindNeighbors(dims = 1:30)\n  Idents(obj1) &lt;- obj1$tissuetype\n  mmu_visium_lst[[idx]] &lt;- obj1\n}\n## figS1c: all genes of each sample ----\nrds_fn2 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/mmu_visium_lst.rds\"\nmmu_visium_lst &lt;- read_rds(rds_fn2)\nfor(idx in c(\"E9.5\", \"E11.5\", \"E13.5\")) {\n  obj1 &lt;- mmu_visium_lst[[idx]]\n  circ_dat &lt;- prepare_circlize_data(obj1, scale = .65)\n  clust_cols &lt;- cols_tissue[order(unique(circ_dat$tissuetype))] # caution: the color must be orderd by the names, as a-z\n  lgd_squre &lt;- ComplexHeatmap::Legend(at = names(stg_cols), type = \"grid\",\n                                      legend_gp = gpar(fill = stg_cols),\n                                      title_position = \"topleft\", title = \"stage\")\n  pdf(glue(\"figS1c_plot1cell_all_genes_{idx}.pdf\"), width = 8, height = 8)\n  plot_circlize(circ_dat, do.label = T, pt.size = 0.5,\n                col.use = clust_cols ,bg.color = 'white',\n                kde2d.n = 200, repel = T, label.cex = .9)\n  \n  add_track(circ_dat, group = \"stage\", colors = stg_cols[idx], track_num = 2)\n  draw(lgd_squre, x = unit(40, \"mm\"), y = unit(12, \"mm\"), just = c(\"right\", \"bottom\"))\n  dev.off()\n}\n## figS1c: metabolic genes of each sample ----\nrds_fn3 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/mmu_visium_mtb_gene_obj_lst.rds\"\nseu_new3_lst &lt;- read_rds(rds_fn3)\nfor(idx in 1:length(seu_new3_lst)) {\n  circ_dat &lt;- prepare_circlize_data(seu_new3_lst[[idx]], scale = .65)\n  clust_cols = cols_tissue[sort(unique(circ_dat$tissuetype))]\n  lgd_squre &lt;- ComplexHeatmap::Legend(at = names(stg_cols), type = \"grid\", \n                                      legend_gp = gpar(fill = stg_cols), \n                                      title_position = \"topleft\", title = \"stage\")\n  pdf(glue(\"figS1c_plot1cell_mtb_genes_{names(seu_lst3)[idx]}.pdf\"), width = 8, height = 8)\n  plot_circlize(circ_dat, do.label = T, pt.size = 0.5,\n                col.use = clust_cols ,bg.color = 'white',\n                kde2d.n = 200, repel = T, label.cex = .6)\n  \n  add_track(circ_dat, group = \"stage\", colors = stg_cols[names(seu_lst3)[idx]], track_num = 2) \n  \n  draw(lgd_squre, x = unit(40, \"mm\"), y = unit(12, \"mm\"), just = c(\"right\", \"bottom\"))\n  dev.off()\n}",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Sup Figure 1</span>"
    ]
  },
  {
    "objectID": "sfig2.html",
    "href": "sfig2.html",
    "title": "\n13  sfig2\n",
    "section": "",
    "text": "pkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"paletteer\", \"cowplot\", \"ComplexHeatmap\", \"circlize\", \"plot1cell\")  \nfor (pkg in pkgs) {\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/figS2\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"tissue\")\nstg_cols &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"stage\")[c(\"CS12\", \"CS14\", \"CS18\")]\n## figS2c: plot1cell of all genes ----\nrds_fn6 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/human_visium_all_gene_lst.rds\"\nseu_new2_lst = read_rds(rds_fn6)\nfor(idx in 1:length(seu_new2_lst)){\n  circ_dat &lt;- prepare_circlize_data(seu_new2_lst[[idx]], scale = .65)\n  clust_cols = cols_tissue[sort(unique(circ_dat$tissue))]\n  lgd_squre &lt;- ComplexHeatmap::Legend(at = names(stg_cols), type = \"grid\", \n                                      legend_gp = gpar(fill = stg_cols), \n                                      title_position = \"topleft\", title = \"stage\")\n  pdf(glue(\"figS2c_plot1cell_all_genes_{names(seu_new2_lst)[idx]}.pdf\"), width = 8, height = 8)\n  plot_circlize(circ_dat, do.label = T, pt.size = 0.5,\n                col.use = clust_cols ,bg.color = 'white',\n                kde2d.n = 200, repel = T, label.cex = .9)\n  add_track(circ_dat, group = \"stage\", colors = stg_cols[unique(seu_new2_lst[[idx]]$stage)], track_num = 2) \n  draw(lgd_squre, x = unit(40, \"mm\"), y = unit(12, \"mm\"), just = c(\"right\", \"bottom\"))\n  dev.off()\n}\n\n## figS2c: plot1cell of mtb genes ----\nrds_fn7 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/human_visium_all_gene_lst.rds\"\nseu_new3_lst = read_rds(rds_fn7)\nfor(idx in 1:length(seu_new3_lst)){\n  circ_dat &lt;- prepare_circlize_data(seu_new3_lst[[idx]], scale = .65)\n  clust_cols = cols_tissue[sort(unique(circ_dat$tissue))]\n  lgd_squre &lt;- ComplexHeatmap::Legend(at = names(stg_cols), type = \"grid\", \n                                      legend_gp = gpar(fill = stg_cols), \n                                      title_position = \"topleft\", title = \"stage\")\n  pdf(glue(\"figS3_human_plot1cell_mtb_genes_{unique(seu_new3_lst[[idx]]$stage)}.pdf\"), width = 8, height = 8)\n  plot_circlize(circ_dat, do.label = T, pt.size = 0.5,\n                col.use = clust_cols ,bg.color = 'white',\n                kde2d.n = 200, repel = T, label.cex = .6)\n  \n  add_track(circ_dat, group = \"stage\", colors = stg_cols[unique(seu_new3_lst[[idx]]$stage)], track_num = 2) \n  \n  draw(lgd_squre, x = unit(40, \"mm\"), y = unit(12, \"mm\"), just = c(\"right\", \"bottom\"))\n  dev.off()\n}\n\n## metabolic genes of each sample ---- \nrds_fn7 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/hsa_visium_mtb_gene_lst.rds\"\nseu_new3_lst = read_rds(rds_fn7)\nfor(idx in 1:length(seu_lst)){\n  circ_dat &lt;- prepare_circlize_data(seu_new3_lst[[idx]], scale = .65)\n  clust_cols = cols_tissue[sort(unique(circ_dat$tissue))]\n  lgd_squre &lt;- ComplexHeatmap::Legend(at = names(stg_cols), type = \"grid\",\n                                      legend_gp = gpar(fill = stg_cols),\n                                      title_position = \"topleft\", title = \"stage\")\n  pdf(glue(\"figS2c_human_plot1cell_mtb_genes_{names(seu_lst)[idx]}_v2.pdf\"), width = 8, height = 8)\n  plot_circlize(circ_dat, do.label = T, pt.size = 0.5,\n                col.use = clust_cols ,bg.color = 'white',\n                kde2d.n = 200, repel = T, label.cex = .6)\n\n  add_track(circ_dat, group = \"stage\", colors = stg_cols[unique(seu_lst[[idx]]$stage)], track_num = 2)\n\n  draw(lgd_squre, x = unit(40, \"mm\"), y = unit(12, \"mm\"), just = c(\"right\", \"bottom\"))\n  dev.off()\n}",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>13</span>  <span class='chapter-title'>Sup Figure 2</span>"
    ]
  },
  {
    "objectID": "sfig3.html",
    "href": "sfig3.html",
    "title": "\n14  sfig3\n",
    "section": "",
    "text": "pkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"paletteer\", \"cowplot\", \"ComplexHeatmap\", \"circlize\", \"plot1cell\")  \nfor (pkg in pkgs) {\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/figS3\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"tissue\")\ncols_stg &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"stage\")\n\n## figS3a: plot1cell of mouse m/z merged data -----\nrds_fn1 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/mouse_mz_mrg_lst.rds\"\nmz_mrg_lst &lt;- read_rds(rds_fn1)\n\nstg_cols &lt;- cols_stg[names(mz_mrg_lst)]\nfor(idx in 1:length(mz_mrg_lst)){\n  circ_dat &lt;- prepare_circlize_data(mz_mrg_lst[[idx]], scale = .7)\n  circ_dat &lt;- circ_dat[!is.na(rownames(circ_dat)), ]\n  clust_cols = cols_tissue[sort(unique(circ_dat$tissuetype))]\n  lgd_squre &lt;- ComplexHeatmap::Legend(at = names(stg_cols), type = \"grid\", \n                                      legend_gp = gpar(fill = stg_cols), \n                                      title_position = \"topleft\", title = \"stage\")\n  pdf(glue(\"figS3_plot1cell_all_mz_{names(mz_mrg_lst)[idx]}.pdf\"), width = 5.5, height = 5.5)\n  plot_circlize(circ_dat, do.label = T, pt.size = 0.4, \n                col.use = clust_cols ,bg.color = 'white', contour.nlevels = 100, \n                kde2d.n = 2000, repel = T, label.cex = .7)\n  \n  add_track(circ_dat, group = \"stage\", colors = stg_cols[names(mz_mrg_lst)[idx]], track_num = 2) \n  \n  draw(lgd_squre, x = unit(25, \"mm\"), y = unit(8, \"mm\"), just = c(\"right\", \"bottom\"))\n  dev.off()\n}\n\nrds_fn2 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/mouse_mz_obj_merged.rds\"\nmz_obj_mrg = read_rds(rds_fn2)\ncirc_dat &lt;- prepare_circlize_data(mz_obj_mrg, scale = .7)\nclust_cols = cols_tissue[sort(unique(circ_dat$tissuetype))]\nlgd_squre &lt;- ComplexHeatmap::Legend(at = names(stg_cols), type = \"grid\", \n                                    legend_gp = gpar(fill = stg_cols), \n                                    title_position = \"topleft\", title = \"stage\")\npdf(glue(\"fig1c_plot1cell_all_mz_mrg.pdf\"), width = 5.5, height = 5.5)\nplot_circlize(circ_dat, do.label = T, pt.size = 0.4, \n              col.use = clust_cols ,bg.color = 'white', contour.nlevels = 100, \n              kde2d.n = 2000, repel = T, label.cex = .7)\n\nadd_track(circ_dat, group = \"stage\", colors = stg_cols[sort(unique(circ_dat$stage))], track_num = 2) \n\ndraw(lgd_squre, x = unit(25, \"mm\"), y = unit(8, \"mm\"), just = c(\"right\", \"bottom\"))\ndev.off()\n\n## figS3c: plot1cell of human m/z merged data -----\nrds_fn3 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/human_mz_mrg_lst.rds\"\nmz_mrg_lst = read_rds(rds_fn3)\nfor(idx in c(\"yao1\", \"yao2\", \"yao5\")){\n  obj1 &lt;- mz_mrg_lst[[idx]][, !is.na(mz_mrg_lst[[idx]]$tissue)]\n  Idents(obj1) &lt;- obj1$tissue\n  circ_dat &lt;- prepare_circlize_data(obj1, scale = .7)\n  circ_dat &lt;- circ_dat[!is.na(rownames(circ_dat)), ]\n  clust_cols = cols_tissue[sort(unique(circ_dat$tissue))]\n  lgd_squre &lt;- ComplexHeatmap::Legend(at = names(stg_cols), type = \"grid\",\n                                      legend_gp = gpar(fill = stg_cols),\n                                      title_position = \"topleft\", title = \"stage\")\n  pdf(glue(\"figS3c_plot1cell_all_mz_{unique(obj1$stage)}.pdf\"), width = 5.5, height = 5.5)\n  plot_circlize(circ_dat, do.label = T, pt.size = 0.4,\n                col.use = clust_cols ,bg.color = 'white', contour.nlevels = 100,\n                kde2d.n = 2000, repel = T, label.cex = .7)\n\n  add_track(circ_dat, group = \"stage\", colors = stg_cols[unique(obj1$stage)], track_num = 2)\n\n  draw(lgd_squre, x = unit(20, \"mm\"), y = unit(8, \"mm\"), just = c(\"right\", \"bottom\"))\n  dev.off()\n}",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>14</span>  <span class='chapter-title'>Sup Figure 3</span>"
    ]
  },
  {
    "objectID": "sfig4.html",
    "href": "sfig4.html",
    "title": "\n15  sfig4\n",
    "section": "",
    "text": "pkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"viridis\")  \nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/sfig4\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nmy_theme1 &lt;- theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"), \n        axis.line = element_line(color = \"black\"), axis.ticks = element_line(color = \"black\"))\n\n## figS4a: visium data specific gene expression -----\nrds_fn1 &lt;- \"../rds/mmu_visium_lst.rds\"\nseu_lst = read_rds(rds_fn1)\n\ne95_genes1 &lt;- c(\"Six3\", \"Trim54\", \"Bhmt\")\ne115_genes1 &lt;- c(\"Dlx1\", \"Adprhl1\", \"Cyp2c70\")\ne135_genes1 &lt;- c(\"Neurog2\", \"Myl7\", \"Kng2\")\ngenes_lst1 &lt;- list(E9.5 = e95_genes1, E11.5 = e115_genes1, E13.5 = e135_genes1)\nplst1 &lt;- lapply(paste0(\"E\", c(9.5, 11.5, 13.5)), \\(stg) {\n  if(stg == \"E9.5\") {\n    scale_fct &lt;- 4.5\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n    sel_img &lt;- \"slice1\"\n  } else if (stg == \"E11.5\") {\n    scale_fct &lt;- 2.4\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n    sel_img &lt;- \"slice1.3\"\n  } else {\n    scale_fct &lt;- 4.5\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n    sel_img &lt;- \"slice1.2\"\n  }\n  \n  feats &lt;- genes_lst1[[stg]]\n  p1 &lt;- Seurat::SpatialFeaturePlot(seu_lst[[stg]], features = feats, ncol = 3, \n                                   pt.size.factor = scale_fct, images = sel_img) & my_theme1 & \n    Seurat::NoAxes() & coord_fixed()\n  ggsave(glue(\"sfig4ac_mouse_gene_expr_{stg}.pdf\"), p1, \n         width = plot_width * 3, height = plot_height, unit = \"in\")\n})\n\n## figS4d: visium data specific metabolic genes ----\ne95_genes2 &lt;- c(\"Gad2\", \"Kcnj5\", \"Bhmt\")\ne115_genes2 &lt;- c(\"Kcnk10\", \"Kcnj5\", \"Apof\")\ne135_genes2 &lt;- c(\"Gad1\", \"Cox7a1\", \"Miox\")\ngenes_lst2 &lt;- list(E9.5 = e95_genes2, E11.5 = e115_genes2, E13.5 = e135_genes2)\nplst2 &lt;- lapply(paste0(\"E\", c(9.5, 11.5, 13.5)), \\(stg) {\n  if(stg == \"E9.5\") {\n    scale_fct &lt;- 3\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n    sel_img &lt;- \"slice1\"\n  } else if (stg == \"E11.5\") {\n    scale_fct &lt;- 1.6\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n    sel_img &lt;- \"slice1.3\"\n  } else {\n    scale_fct &lt;- 2\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n    sel_img &lt;- \"slice1.2\"\n  }\n  \n  feats &lt;- genes_lst2[[stg]]\n  Seurat::DefaultAssay(seu_lst[[stg]]) &lt;- \"SCT\"\n  p1 &lt;- Seurat::SpatialFeaturePlot(seu_lst[[stg]], features = feats, ncol = 3, slot = \"data\", \n                                   pt.size.factor = scale_fct, images = sel_img) & my_theme1 & \n    Seurat::NoAxes() & coord_fixed()\n  ggsave(glue(\"sfig4df_mouse_mtb_gene_expr_{stg}.pdf\"), p1, \n         width = plot_width * 3, height = plot_height, unit = \"in\")\n})\n\n## figS4g-i: ssgsea score of KEGG pathways -----\nkegg_info &lt;- read_csv(\n  \"/cluster/home/danyang_jh/ref/kegg/mouse/kegg_mmu_all_pth_genes.csv\"\n)\nkegg_pth_id &lt;- kegg_info[, c(1, 3)] %&gt;% dplyr::distinct()\nrds_fn2 &lt;- \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/sfig4gi_ssgsea_score_df_lst1.rds\"\ndf_lst1 &lt;- read_rds(rds_fn2)\nsel_pth1 &lt;- \n  dplyr::filter(kegg_pth_id, \n                grepl(\"(GABA|Glutamater|Taurine|Cardiac|Insulin sig|cAMP|Pentose pho|Purine|Pyrimi)\", \n                      pth_name))\np_lst1 &lt;- lapply(1:nrow(sel_pth1), \\(idx) {\n  p_df1 &lt;- df_lst1 %&gt;% dplyr::select(all_of(c(\"imagerow\", \"imagecol\", \"stage\", sel_pth1[[1]][idx]))) %&gt;%\n    dplyr::rename(\"pth\" = sel_pth1[[1]][idx])\n  p_df1 &lt;- mutate(p_df1, imagecol = case_when(stage == \"E11.5\" ~ imagecol, stage == \"E9.5\" ~ imagecol, \n                                              stage == \"E13.5\" ~ -1 * imagecol), \n                  imagerow = case_when(stage == \"E11.5\" ~ -1 * imagerow, stage == \"E9.5\" ~ -1 * imagerow, \n                                       stage == \"E13.5\" ~ imagerow)) %&gt;% \n    mutate(stage = fct(as.character(stage), levels = c(\"E9.5\", \"E11.5\", \"E13.5\")))\n  ggplot2::ggplot(p_df1, aes(x = imagecol, y = imagerow, color = pth)) +\n    geom_point(size = .5) + viridis::scale_color_viridis() + facet_wrap(~ stage, scale = \"free\") +\n    my_theme1 + Seurat::NoAxes() + labs(title = sel_pth1[[2]][idx], color = \"\")\n})\npdf(\"sfig4gi_ssgsea_score.pdf\", width = 6, height = 3)\nprint(p_lst1)\ndev.off()\n\n## figS9d: signaling score ----\nsel_pth2 &lt;- \n  dplyr::filter(kegg_pth_id, \n                grepl(\"(Wnt sig|Hedgehog|TGF|Notch sig|HIF|mTOR)\", pth_name))\np_lst2 &lt;- lapply(1:nrow(sel_pth2), \\(idx) {\n  p_df1 &lt;- df_lst1 %&gt;% dplyr::select(all_of(c(\"imagerow\", \"imagecol\", \"stage\", sel_pth2[[1]][idx]))) %&gt;%\n    dplyr::rename(\"pth\" = sel_pth2[[1]][idx])\n  p_df1 &lt;- mutate(p_df1, imagecol = case_when(stage == \"E11.5\" ~ imagecol, stage == \"E9.5\" ~ imagecol, \n                                              stage == \"E13.5\" ~ -1 * imagecol), \n                  imagerow = case_when(stage == \"E11.5\" ~ -1 * imagerow, stage == \"E9.5\" ~ -1 * imagerow, \n                                       stage == \"E13.5\" ~ imagerow)) %&gt;% \n    mutate(stage = fct(as.character(stage), levels = c(\"E9.5\", \"E11.5\", \"E13.5\")))\n  ggplot2::ggplot(p_df1, aes(x = imagecol, y = imagerow, color = pth)) +\n    geom_point(size = .5) + viridis::scale_color_viridis() + facet_wrap(~ stage, scale = \"free\") +\n    my_theme1 + Seurat::NoAxes() + labs(title = sel_pth2[[2]][idx], color = \"\")\n})\npdf(\"sfig9df_ssgsea_score.pdf\", width = 6, height = 3)\nprint(p_lst2)\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>15</span>  <span class='chapter-title'>Sup Figure 4</span>"
    ]
  },
  {
    "objectID": "sfig5.html",
    "href": "sfig5.html",
    "title": "\n16  sfig5\n",
    "section": "",
    "text": "pkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"viridis\", \"FELLA\")  \nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/sfig5\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"tissue\")\nstg_cols &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"stage\")[c(\"CS12\", \"CS14\", \"CS18\")]\n\nmy_theme1 &lt;- theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"), \n        axis.line = element_line(color = \"black\"), axis.ticks = element_line(color = \"black\"))\n\n## figS5a: enrichment of each selected tissues in each stage ----\nxlsx_fn1 = \n  \"/cluster/home/jhuang/projects/collabrators/data/wangwenjie/mouse/metabolism/mouse_adjusted/DZLM2023110146_DZLM2024030584-b1-张进-王文杰-空间代谢组-项目报告/2.定性结果/Qualitative.xlsx\"\nmz_anot_neg = readxl::read_excel(xlsx_fn1, sheet = \"neg-all\") %&gt;% mutate(mode = \"neg\")\nmz_anot_pos = readxl::read_excel(xlsx_fn1, sheet = \"pos-all\") %&gt;% mutate(mode = \"pos\")\nmz_anot = rbind(mz_anot_neg, mz_anot_pos) %&gt;% mutate(mz_id = paste0(mode, \"-\", mz))\n\ncsv_fn1 &lt;- \"../rds/fig2g_mouse_mz_liver_long_fc.csv\"\nmz_mmu = read_csv(csv_fn1) %&gt;% .[, 1:2] %&gt;% dplyr::distinct()\n\nmz_trnd_lst = mz_mmu %&gt;% split(f = .$group)\ntmpdir &lt;- \"~/ref/fella/kegg/mmu\" \nfella.data &lt;- loadKEGGdata(databaseDir = tmpdir, internalDir = FALSE, \n                           loadMatrix = c(\"diffusion\", \"pagerank\", \"hypergeom\"))\n\n\nfor(trnd in names(mz_trnd_lst)) {\n  keg_id &lt;- mz_anot %&gt;% dplyr::filter(mz_id %in% mz_trnd_lst[[trnd]][[1]]) %&gt;% .$KEGG %&gt;% \n    na.omit() %&gt;% unique()\n  anls &lt;- enrich(compounds = keg_id, data = fella.data, \n                 method = c(\"diffusion\", \"pagerank\", \"hypergeom\"), approx = \"normality\")\n  getExcluded(anls)\n  enrich_res_lst = pbmcapply::pbmclapply(c(\"diffusion\", \"pagerank\", \"hypergeom\"), \\(mth) {\n    res_tbl &lt;- generateResultsTable(method = mth, threshold = 1, \n                                    capPscores = 0, object = anls, data = fella.data)\n    pth_nms &lt;- vector(mode = \"character\", length = nrow(res_tbl))\n    for(idx in 1:nrow(res_tbl)){\n      pth_nms[idx] &lt;- fella.data@keggdata@id2name[[res_tbl$`KEGG.id`[idx]]]\n    }\n    res_tbl[[\"KEGG.name\"]] &lt;- stringr::str_split(pth_nms, \" - Mus mus\", simplify = T)[, 1]\n    res_tbl &lt;- res_tbl %&gt;% mutate(method = mth, trend = trnd)\n  }, mc.cores = 3)\n  writexl::write_xlsx(enrich_res_lst, path = glue(\"figS5f_enrich_{trnd}.xlsx\"), \n                     col_names = T, format_headers = T)\n}\n# figS5f: enrichment of each selected tissues in each stage ----\nkegg_mtb_pth = read_csv(\"~/ref/kegg/mmu\")\nenrich_res1 = lapply(names(mz_trnd_lst), \\(trnd) {\n  enrich_res = readxl::read_xlsx(glue(\"figS5f_enrich_{trnd}.xlsx\"), sheet = 1) \n}) %&gt;% bind_rows()\nenrich_res2 = lapply(names(mz_trnd_lst), \\(trnd) {\n  enrich_res = readxl::read_xlsx(glue(\"figS5f_enrich_{trnd}.xlsx\"), sheet = 2) \n}) %&gt;% bind_rows()\n\nenrich_res = lapply(names(mz_trnd_lst), \\(trnd) {\n  enrich_res = readxl::read_xlsx(glue(\"figS5f_enrich_{trnd}.xlsx\"), sheet = 3) \n}) %&gt;% bind_rows()\nmmu_mtb_pth = read_rds(\"~/ref/kegg/mouse/mmu_mtb_pth_cpd.rds\")\n\np_tbl1 = enrich_res %&gt;% dplyr::filter(KEGG.id %in% unique(mmu_mtb_pth[[1]])) %&gt;% \n  group_by(trend) %&gt;% dplyr::slice_min(order_by = p.value, n = 4) %&gt;% \n  dplyr::arrange(trend, desc(p.value)) %&gt;% dplyr::mutate(KEGG.name = as.character(KEGG.name) %&gt;% fct())\nbar1 = ggplot2::ggplot(p_tbl1, aes(x = -log10(p.value), y = KEGG.name, fill = trend)) + \n  geom_bar(stat = \"identity\", position = \"dodge\") + my_theme1 + \n  ggplot2::facet_grid(trend ~ ., space = \"free\", scales = \"free_y\") + \n  scale_fill_manual(values = unname(cols_tissue)[c(1, 3, 4, 5, 6)]) + labs(y = \"\") + \n  theme(legend.position = \"none\", \n        axis.line = element_blank(), panel.border = element_rect(fill = NA, linewidth = .5))\nggsave(\"mmu_liver_trend_mz_enrich_bar1.pdf\", bar1, width = 8, height = 10, unit = \"cm\")",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>16</span>  <span class='chapter-title'>Sup Figure 5</span>"
    ]
  },
  {
    "objectID": "sfig6.html",
    "href": "sfig6.html",
    "title": "\n17  sfig6\n",
    "section": "",
    "text": "pkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"viridis\")  \nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/sfig6\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nmy_theme1 &lt;- theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"), \n        axis.line = element_line(color = \"black\"), axis.ticks = element_line(color = \"black\"))\n\n## figS5a: visium data specific gene expression -----\nrds_fn1 &lt;- \"../rds/hsa_visium_obj_lst.rds\"\nseu_lst = read_rds(rds_fn1)\n\nyao1_genes1 &lt;- c(\"PAX5\", \"LRRC10\", \"SULT1E1\")\nyao2_genes1 &lt;- c(\"FOXL2\", \"LRRC10\", \"CYP3A7\")\nyao5_genes1 &lt;- c(\"FOXL2\", \"NKX2-5\", \"SLC17A1\")\ngenes_lst1 &lt;- list(yao1 = yao1_genes1, yao2 = yao2_genes1, yao5 = yao5_genes1)\nplst1 &lt;- lapply(paste0(\"yao\", c(1, 2, 5)), \\(stg) {\n  if(stg == \"yao1\") {\n    scale_fct &lt;- 3\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n    # sel_img &lt;- \"slice1\"\n  } else if (stg == \"yao2\") {\n    scale_fct &lt;- 1.8\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n    # sel_img &lt;- \"slice1.3\"\n  } else {\n    scale_fct &lt;- 1.2\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n    # sel_img &lt;- \"slice1.2\"\n  }\n  \n  feats &lt;- genes_lst1[[stg]]\n  p1 &lt;- Seurat::SpatialFeaturePlot(seu_lst[[stg]], features = feats, ncol = 3, \n                                   pt.size.factor = scale_fct, stroke = NA, #images = sel_img\n                                   ) & my_theme1 & \n    Seurat::NoAxes() & coord_fixed()\n  ggsave(glue(\"sfig6ac_human_gene_expr_{stg}.pdf\"), p1, \n         width = plot_width * 3, height = plot_height, unit = \"in\")\n})\n\n## figS5d: visium data specific metabolic genes ----\nyao1_genes2 &lt;- c(\"NOS2\", \"COX6A2\", \"SLC13A5\")\nyao2_genes2 &lt;- c(\"SLC6A1\", \"COX6A2\", \"KLB\")\nyao5_genes2 &lt;- c(\"SLC4A4\", \"SLC5A1\", \"SLC23A1\")\ngenes_lst2 &lt;- list(yao1 = yao1_genes2, yao2 = yao2_genes2, yao5 = yao5_genes2)\nplst2 &lt;- lapply(paste0(\"yao\", c(1, 2, 5)), \\(stg) {\n  if(stg == \"yao1\") {\n    scale_fct &lt;- 3\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n    # sel_img &lt;- \"slice1\"\n  } else if (stg == \"yao2\") {\n    scale_fct &lt;- 1.8\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n    # sel_img &lt;- \"slice1.3\"\n  } else {\n    scale_fct &lt;- 1.2\n    plot_width &lt;- 3\n    plot_height &lt;- 3\n    # sel_img &lt;- \"slice1.2\"\n  }\n  \n  feats &lt;- genes_lst2[[stg]]\n  Seurat::DefaultAssay(seu_lst[[stg]]) &lt;- \"SCT\"\n  p1 &lt;- Seurat::SpatialFeaturePlot(seu_lst[[stg]], features = feats, ncol = 3, slot = \"data\", \n                                   pt.size.factor = scale_fct, stroke = NA, #images = sel_img\n                                   ) & my_theme1 & \n    Seurat::NoAxes() & coord_fixed()\n  ggsave(glue(\"sfig6df_human_mtb_gene_expr_{stg}.pdf\"), p1, \n         width = plot_width * 3, height = plot_height, unit = \"in\")\n})\n\n## ssgsea score re-scale -----",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>17</span>  <span class='chapter-title'>Sup Figure 6</span>"
    ]
  },
  {
    "objectID": "sfig7.html",
    "href": "sfig7.html",
    "title": "\n18  sfig7\n",
    "section": "",
    "text": ".libPaths(new = c(.libPaths(), \"~/sbin/R/R-4.3.0\"))\npkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"viridis\", \"FELLA\")  \nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"human\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/sfig7\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/human/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"tissue\")\nstg_cols &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"stage\")[c(\"CS12\", \"CS14\", \"CS18\")]\n\nmy_theme1 &lt;- theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"), \n        axis.line = element_line(color = \"black\"), axis.ticks = element_line(color = \"black\"))\n\n\n## figS5a: enrichment of each selected tissues in each stage ----\nxlsx_fn1 = \n  \"/cluster/home/jhuang/projects/collabrators/data/wangwenjie/human/metabolism/human_adjusted/DZLM2024030584-b2_DZLM2024030572-张进-王文杰-空间代谢组-项目报告/2.定性结果/Qualitative.xlsx\"\nmz_anot_neg = readxl::read_excel(xlsx_fn1, sheet = \"neg-all\") %&gt;% mutate(mode = \"neg\")\nmz_anot_pos = readxl::read_excel(xlsx_fn1, sheet = \"pos-all\") %&gt;% mutate(mode = \"pos\")\nmz_anot = rbind(mz_anot_neg, mz_anot_pos) %&gt;% mutate(mz_id = paste0(mode, \"-\", mz))\n\ncsv_fn1 &lt;- \"/cluster/home/ztao_jh/projects/embryo/analysis/zhangjing/human/rnaseq/new_label/ren_time_point_2/neg/Liver.csv\"\nmz_hsa &lt;- read_csv(csv_fn1) %&gt;% .[, 1:2] %&gt;% \n  dplyr::filter(!grepl(\"Trend7\", group)) %&gt;% dplyr::distinct()\n\nmz_trnd_lst = mz_hsa %&gt;% split(f = .$group)\ntmpdir &lt;- \"~/ref/fella/kegg/hsa/tst2\" \nfella.data &lt;- loadKEGGdata(databaseDir = tmpdir, internalDir = FALSE, \n                           loadMatrix = c(\"diffusion\", \"pagerank\", \"hypergeom\"))\n\n\nfor(trnd in names(mz_trnd_lst)) {\n  keg_id &lt;- mz_anot %&gt;% dplyr::filter(mz_id %in% mz_trnd_lst[[trnd]][[1]]) %&gt;% .$KEGG %&gt;% \n    na.omit() %&gt;% unique()\n  anls &lt;- enrich(compounds = keg_id, data = fella.data, \n                 method = c(\"diffusion\", \"pagerank\", \"hypergeom\"), approx = \"normality\")\n  getExcluded(anls)\n  enrich_res_lst = pbmcapply::pbmclapply(c(\"diffusion\", \"pagerank\", \"hypergeom\"), \\(mth) {\n    res_tbl &lt;- generateResultsTable(method = mth, threshold = 1, \n                                    capPscores = 0, object = anls, data = fella.data)\n    pth_nms &lt;- vector(mode = \"character\", length = nrow(res_tbl))\n    for(idx in 1:nrow(res_tbl)){\n      pth_nms[idx] &lt;- fella.data@keggdata@id2name[[res_tbl$`KEGG.id`[idx]]]\n    }\n    res_tbl[[\"KEGG.name\"]] &lt;- stringr::str_split(pth_nms, \" - Mus mus\", simplify = T)[, 1]\n    res_tbl &lt;- res_tbl %&gt;% mutate(method = mth, trend = trnd)\n  }, mc.cores = 3)\n  writexl::write_xlsx(enrich_res_lst, path = glue(\"figS5a_enrich_{trnd}.xlsx\"), \n                      col_names = T, format_headers = T)\n}\n# figS5f: enrichment of each selected tissues in each stage ----\n\nenrich_res = lapply(names(mz_trnd_lst), \\(trnd) {\n  enrich_res = readxl::read_xlsx(glue(\"figS5a_enrich_{trnd}.xlsx\"), sheet = 3) \n}) %&gt;% bind_rows()\nhsa_mtb_pth = read_rds(\"~/ref/kegg/human/hsa_mtb_pth_cpd.rds\")\n\np_tbl1 = enrich_res %&gt;% dplyr::filter(KEGG.id %in% unique(hsa_mtb_pth[[1]])) %&gt;% \n  group_by(trend) %&gt;% dplyr::slice_min(order_by = p.value, n = 4) %&gt;% \n  dplyr::arrange(trend, desc(p.value)) %&gt;% \n  dplyr::mutate(KEGG.name = str_split(KEGG.name, \" - Homo\", simplify = T)[, 1]) %&gt;% \n  dplyr::mutate(KEGG.name = as.character(KEGG.name) %&gt;% fct())\nbar1 = ggplot2::ggplot(p_tbl1, aes(x = -log10(p.value), y = KEGG.name, fill = trend)) + \n  geom_bar(stat = \"identity\", position = \"dodge\") + my_theme1 + \n  ggplot2::facet_grid(trend ~ ., space = \"free\", scales = \"free_y\") + \n  scale_fill_manual(values = unname(cols_tissue)) + labs(y = \"\") + \n  theme(legend.position = \"none\", \n        axis.line = element_blank(), panel.border = element_rect(fill = NA, linewidth = .5))\nggsave(\"hsa_liver_trend_mz_enrich_bar1.pdf\", bar1, width = 8, height = 10, unit = \"cm\")",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>18</span>  <span class='chapter-title'>Sup Figure 7</span>"
    ]
  },
  {
    "objectID": "sfig8.html",
    "href": "sfig8.html",
    "title": "\n19  sfig8\n",
    "section": "",
    "text": "pkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"viridis\")  \nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/sfig8\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"tissue\")\nstg_cols &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"stage\")[c(\"CS12\", \"CS14\", \"CS18\")]\n\nmy_theme1 &lt;- theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"), \n        axis.line = element_line(color = \"black\"), axis.ticks = element_line(color = \"black\"))\n\n## figS8a-c: mouse TF clustering -----\nsamples &lt;- c(\"ME9.5\", \"ME11.5x1\", \"ME13.5\")\nfor(samp in samples) {\n  csv_fn2 &lt;- \n    glue(\"/cluster/home/ztao_jh/projects/embryo/analysis/zhangjing/human/rnaseq/pyscenic/mouse/{samp}/{samp}_SCENIC.csv\")\n  tf_score &lt;- read_csv(csv_fn2) %&gt;% mutate(barcode = str_sub(Cell, end = -3))\n  \n  tf_sds &lt;- tf_score %&gt;% as.data.frame() %&gt;% dplyr::select(-c(\"barcode\")) %&gt;% \n    column_to_rownames(\"Cell\") %&gt;% t() %&gt;% matrixStats::rowSds()\n  cor_mtx &lt;- tf_score %&gt;% as.data.frame() %&gt;% dplyr::select(-c(\"barcode\")) %&gt;% \n    column_to_rownames(\"Cell\") %&gt;% as.matrix() %&gt;% .[, names(tf_sds[tf_sds &gt; 0])] %&gt;% cor() \n  htp1 &lt;- ComplexHeatmap::Heatmap(cor_mtx, show_row_names = F, show_column_names = F, \n                                  clustering_method_rows = \"complete\", clustering_method_columns = \"complete\", \n                                  row_split = 7, column_split = 7, name = \"cor\", raster_by_magick = T)\n  pdf(glue(\"{samp}_cor_htp1.pdf\"), width = 5, height = 5)\n  print(htp1)\n  dev.off()\n}\n\n## figS8d-f ----\nsamples &lt;- c(\"yao1\", \"yao2\", \"yao5\")\nfor(samp in samples) {\n  csv_fn2 &lt;- \n    glue(\"/cluster/home/ztao_jh/projects/embryo/analysis/zhangjing/human/rnaseq/pyscenic/human/{samp}/{samp}_SCENIC.csv\")\n  tf_score &lt;- read_csv(csv_fn2) %&gt;% mutate(barcode = str_sub(Cell, end = -3))\n  \n  tf_sds &lt;- tf_score %&gt;% as.data.frame() %&gt;% dplyr::select(-c(\"barcode\")) %&gt;% \n    column_to_rownames(\"Cell\") %&gt;% t() %&gt;% matrixStats::rowSds()\n  cor_mtx &lt;- tf_score %&gt;% as.data.frame() %&gt;% dplyr::select(-c(\"barcode\")) %&gt;% \n    column_to_rownames(\"Cell\") %&gt;% as.matrix() %&gt;% .[, names(tf_sds[tf_sds &gt; 0])] %&gt;% cor() \n  htp1 &lt;- ComplexHeatmap::Heatmap(cor_mtx, show_row_names = F, show_column_names = F, \n                                  clustering_method_rows = \"complete\", clustering_method_columns = \"complete\", \n                          row_split = 7, column_split = 7, name = \"cor\", raster_by_magick = T)\n  pdf(glue(\"{samp}_cor_htp1.pdf\"), width = 5, height = 5)\n  print(htp1)\n  dev.off()\n  \n}",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>19</span>  <span class='chapter-title'>Sup Figure 8</span>"
    ]
  },
  {
    "objectID": "sfig10.html",
    "href": "sfig10.html",
    "title": "\n20  sfig10\n",
    "section": "",
    "text": "pkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \n          \"viridis\", \"RColorBrewer\")  \nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"collabrators\"\ndataset &lt;- \"wangwenjie\"\nspecies &lt;- \"mouse\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/figures/sfig10\")\nworkdir %&gt;% fs::dir_create() %&gt;% setwd()\n\nyaml_fn &lt;- \"/cluster/home/danyang_jh/projects/collabrators/code/wangwenjie/mouse/figures/configs.yaml\"\ncols_tissue &lt;- jhtools::show_me_the_colors(config_fn= yaml_fn, \"tissue\")\nstg_cols &lt;- jhtools::show_me_the_colors(config_fn = yaml_fn, \"stage\")[c(\"CS12\", \"CS14\", \"CS18\")]\n\nmy_theme1 &lt;- theme_classic(base_size = 8) + \n  theme(legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\"), \n        axis.line = element_line(color = \"black\"), axis.ticks = element_line(color = \"black\"))\n\n## figS10d: monocle2 results of E11.5 somite, visium data -----\nrds_fn1 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/align_new/mtb_new/pseudotime/cds_vld.rds\"\ncds_vld = read_rds(rds_fn1)\n\np1 &lt;- monocle::plot_cell_trajectory(cds_vld, cell_size= .2, color_by = \"State\") + \n  theme_classic(base_size= 8) + scale_color_manual(values = unname(stg_cols)) + \n  theme( legend.key.size = unit(3, \"mm\"), axis.text = element_text(color = \"black\")) + \n  coord_fixed()\nggsave(\"sfig10d_ddrtree_state.pdf\", p1, width = 3, height = 2)\n\nrds_fn2 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/fig5d_mouse_e11.5_gene_seu1_somite2.rds\"\nseu1_somite2 &lt;- read_rds(rds_fn2)\nseu1_somite2$State &lt;- cds_vld$State\n\nsp1 &lt;- Seurat::SpatialDimPlot(seu1_somite2, group.by = 'State', pt.size.factor = 2,\n                       label = F, label.size = 2, label.color = \"black\", label.box = F,\n                       repel = T) & \n  theme_classic(base_size= 8) & #labs(title = \"The State of E11.5 somite\") &\n  scale_fill_manual(values = unname(stg_cols)) & \n  theme(legend.key.size = unit(3, \"mm\")) & coord_fixed()\nggsave(\"sfig10d_e11.5_somite_state_spatial.pdf\", sp1, width = 3, height = 2)\n\n## figS10e: metabolic genes heatmap -----\nrds_fn3 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/mouse/figures/rds/sfig10e_e11.5_somite_htp_df.rds\"\ndf &lt;- read_rds(rds_fn3)\n\npdf(\"sfig10e_e11.5_somite_heatmap1.pdf\", width = 6, height = 8)\nvisCluster(object = df, plot.type = \"both\")\ndev.off()\n\n## figS10f: gene enrichment of metabolic gene cluster 4 ----\nxlsx_fn1 &lt;- \n  \"/cluster/home/danyang_jh/projects/collabrators/analysis/wangwenjie/align_new/mtb_new/pseudotime_250116/mtb_gene_4clusters/enrich_kegg_res_lst.xlsx\"\nenrich_res &lt;- readxl::read_excel(xlsx_fn1, sheet = 4)\nenrich_res &lt;- enrich_res %&gt;% \n  dplyr::mutate(bg_num = str_split(BgRatio, \"/\", simplify = T)[, 1] %&gt;% as.numeric()) %&gt;% \n  dplyr::mutate(set_num = str_split(GeneRatio, \"/\", simplify = T)[, 2] %&gt;% as.numeric()) %&gt;% \n  mutate(ratio = Count/bg_num) %&gt;% mutate(generatio = Count/set_num) %&gt;% \n  dplyr::filter(category == \"Metabolism\") %&gt;% \n  dplyr::slice_head(n = 10) %&gt;% dplyr::arrange(generatio) %&gt;% \n  mutate(Description = fct(as.character(Description)))\npt1 &lt;- ggplot2::ggplot(enrich_res, aes(x = generatio, y = Description, color = -log10(p.adjust), size = Count)) + \n  geom_point() + viridis::scale_color_viridis() + my_theme1 + \n  ggplot2::scale_y_discrete(label = function(x) str_wrap(x, width = 30)) + \n  theme(axis.line = element_blank(), panel.border = element_rect(linewidth = .5, fill = NA, color = \"black\")) + \n  labs(x = \"Gene Ratio\", y = \"\", title = \"Metabolic pathways in cluster4\")\nggsave(\"sfig10f_kegg_mtb_enrich_clust4.pdf\", pt1, width = 5, height = 3)\n\n## figS10g-j: local focus of specific genes in the selected pathways -----\nGetAllCoordinates &lt;- function(.data) {\n  .data@images %&gt;%\n    names() %&gt;%\n    unique() %&gt;%\n    map_dfr(~{\n      GetTissueCoordinates(\n        .data,\n        image = .x,\n        cols = c(\"row\", \"col\"),\n        scale = NULL\n      ) %&gt;%\n        rownames_to_column(var = \"cellid\")\n    })\n}\n\ncelltype_isoheight_plot &lt;- function(\n    .data, \n    gn = NULL, \n    col_bg = \"gray70\",\n    col_top = \"darkred\",\n    col_isoheight = \"white\",\n    col_white_ratio = .25,\n    cols_fill_isoheight = c(\n      rep(\"white\", round(100 * .25)),\n      colorRampPalette(brewer.pal(5, \"YlOrRd\")[2:5])(round(100 * (1 - .25)))\n    ),\n    size_bg = 0.2,\n    size_top = size_bg\n) {\n  \n  df &lt;- .data@meta.data %&gt;%\n    rownames_to_column(\"cellid\") %&gt;%\n    inner_join(\n      GetAllCoordinates(.data)\n    ) %&gt;%\n    as_tibble() %&gt;% mutate(row = -1 * row)\n  \n  xy_r &lt;- max(df$col, df$row)\n  \n  p &lt;- ggplot(mapping = aes(x = row, y = col)) +\n    ggplot2::geom_point(\n      data = df, show.legend = T, \n      color = col_bg, alpha = .8, size = size_bg\n    )\n  p &lt;- p +\n    ggnewscale::new_scale_fill() +\n    ggplot2::stat_density_2d_filled(\n      data = df %&gt;% dplyr::filter(top_n),\n      mapping = aes(fill = ..ndensity.., alpha = ..ndensity.. ),\n      geom = \"raster\", contour = F\n    ) +\n    scale_fill_gradientn(colours = cols_fill_isoheight) + \n    ggnewscale::new_scale_fill() +\n    geom_density_2d(\n      data = df %&gt;% dplyr::filter(top_n),\n      color = col_isoheight, \n      contour_var   = \"ndensity\", alpha = .5, \n      show.legend = T, linewidth = .2\n    )\n  \n  p &lt;- p +\n    geom_point(\n      data = df %&gt;% dplyr::filter(top_n), show.legend = T, \n      color = col_top, alpha = .8, size = size_top\n    ) + labs(color = 'top 10%')\n  \n  x_min &lt;- min(df$row)\n  x_max &lt;- max(df$row)\n  y_min = min(df$col)\n  y_max = max(df$col)\n  p &lt;- p +\n    ggplot2::coord_fixed(ratio = 1, xlim = c(1.05 * x_min, 0.9 * x_max), \n                         ylim = c(0.9 * y_min, 1.05 * y_max), expand = F) +\n    theme_classic(base_size = 8) + \n    theme(\n      legend.key.size = unit(3, \"mm\"), \n      axis.line = element_blank(), \n      axis.title = element_blank(), \n      axis.text = element_blank(), \n      axis.ticks = element_blank(), \n      plot.title = element_text(hjust = .5), \n      panel.border = element_rect(linewidth = .5, fill = NA)\n    ) + labs(title = gn)\n}\n\nsel_genes &lt;- list(\n  gly = c(\"Pgam2\", \"Pkm\", \"Eno3\"), \n  aa = c(\"Shmt1\", \"Gatm\"), \n  nucleotide = c(\"Paics\", \"Ampd1\"), \n  fa = c(\"Hsd17b12\", \"Isyna1\")\n  )\nfeats_lst &lt;- list()\nfor(gn in unlist(sel_genes)) {\n  val &lt;- LayerData(seu1_somite2[[\"Spatial\"]], \"counts\")[gn, ]\n  seu1_somite2$top_n &lt;- case_when(val &gt; quantile(val, probs = .85) ~ TRUE, TRUE ~ FALSE)\n  feats_lst[[gn]] &lt;- \n    celltype_isoheight_plot(.data = seu1_somite2, col_bg = \"gray70\", col_top = \"darkred\", \n                            col_isoheight = \"white\", gn = gn, col_white_ratio = .25,\n                            cols_fill_isoheight = c(\n                              rep(\"white\", round(100 * .25)),\n                              colorRampPalette(brewer.pal(5, \"YlOrRd\")[2:5])(round(100 * (1 - .25)))\n                            ), size_bg = 0.2, size_top = .2)\n}\npdf(\"sfig10gj_e11.5_somite_mtb_genes.pdf\", width = 2, height = 3)\nprint(feats_lst)\ndev.off()",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>20</span>  <span class='chapter-title'>Sup Figure 10</span>"
    ]
  }
]